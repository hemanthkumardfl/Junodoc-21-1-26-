<apex:page docType="html-5.0" showHeader="false" sidebar="false" standardStylesheets="false" applyHtmlTag="false" applyBodyTag="false" controller="JunoSignUploadePdfController">
    <html>
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>PDF Editor</title>
            <!-- Load required libraries -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
            <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
            <script src="https://unpkg.com/downloadjs@1.4.7/download.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
            
            <!-- Add fonts for signature styles -->
            <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Homemade+Apple&family=Caveat&family=Kalam&family=Parisienne&family=Sacramento&display=swap" rel="stylesheet" />
            
            <style>
                /* Base styles */
                body {
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                    margin: 0;
                    padding: 0;
                    background: linear-gradient(135deg, #f5f3ff 0%, #dbeafe 50%, #fce7f3 100%);
                    min-height: 100vh;
                }
                
                /* Header styles */
                .header {
                    background: linear-gradient(90deg, #7c3aed 0%, #2563eb 100%);
                    color: white;
                    padding: 1.5rem;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                }
                
                .header-content {
                    max-width: 1200px;
                    margin: 0 auto;
                    text-align: center;
                }
                
                .header-title {
                    font-size: 1.875rem;
                    font-weight: 700;
                    margin: 0;
                }
                
                .beta-badge {
                    background-color: rgba(255, 255, 255, 0.2);
                    padding: 0.25rem 0.5rem;
                    border-radius: 0.375rem;
                    font-size: 0.875rem;
                    vertical-align: top;
                    margin-left: 0.5rem;
                }
                
                .header-subtitle {
                    margin-top: 0.25rem;
                    opacity: 0.8;
                }
                
                /* Main content */
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 2rem 1rem;
                }
                
                /* Upload section */
                .upload-section {
                    background-color: white;
                    border-radius: 0.75rem;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    padding: 2.5rem;
                    text-align: center;
                    max-width: 32rem;
                    margin: 0 auto;
                    border: 2px solid #ddd6fe;
                }
                
                .upload-icon-container {
                    width: 5rem;
                    height: 5rem;
                    background-color: #f5f3ff;
                    border-radius: 9999px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 1rem auto;
                }
                
                .upload-icon {
                    width: 2.5rem;
                    height: 2.5rem;
                    color: #7c3aed;
                }
                
                .upload-title {
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: #5b21b6;
                    margin-bottom: 0.5rem;
                }
                
                .upload-subtitle {
                    color: #7c3aed;
                    margin-bottom: 1.5rem;
                }
                
                .btn {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 500;
                    border-radius: 0.5rem;
                    cursor: pointer;
                    transition: all 0.2s;
                    border: none;
                }
                
                .btn-primary {
                    background: linear-gradient(90deg, #7c3aed 0%, #2563eb 100%);
                    color: white;
                    padding: 1rem 2rem;
                    font-size: 1.125rem;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                }
                
                .btn-primary:hover {
                    background: linear-gradient(90deg, #6d28d9 0%, #1d4ed8 100%);
                }
                
                /* Editor section */
                .editor-section {
                    background-color: white;
                    border-radius: 0.75rem;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    overflow: hidden;
                    border: 2px solid #ddd6fe;
                    display: none; /* Initially hidden */
                    flex-direction: column;
                    height: 100vh;
                }
                
                .editor-toolbar {
                    background: linear-gradient(90deg, #7c3aed 0%, #2563eb 100%);
                    padding: 0.75rem;
                    color: white;
                    display: flex;
                    flex-wrap: wrap;
                    align-items: center;
                    gap: 0.5rem;
                    position: sticky;
                    top: 0;
                    z-index: 30;
                }
                
                .btn-toolbar {
                    background-color: rgba(255, 255, 255, 0.2);
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 0.375rem;
                    display: inline-flex;
                    align-items: center;
                }
                
                .btn-toolbar:hover {
                    background-color: rgba(255, 255, 255, 0.3);
                }
                
                .btn-toolbar svg {
                    margin-right: 0.5rem;
                    width: 1rem;
                    height: 1rem;
                }
                
                .btn-save {
                    background-color: #10b981;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 0.375rem;
                    display: inline-flex;
                    align-items: center;
                    margin-left: auto;
                }
                
                .btn-save:hover {
                    background-color: #059669;
                }
                
                .btn-cancel {
                    background-color: rgba(255, 255, 255, 0.2);
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 0.375rem;
                    margin-right: 0.5rem;
                }
                
                .btn-cancel:hover {
                    background-color: rgba(255, 255, 255, 0.3);
                }
                
                /* PDF Viewer */
                .pdf-container {
                    background-color: #f3f4f6;
                    padding: 1rem;
                    min-height: 600px;
                    position: relative;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 20px;
                    overflow-y: auto;
                    flex: 1;
                    height: calc(100vh - 60px);
                }
                
                .pdf-canvas-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    min-height: 600px;
                    position: relative;
                }
                
                #pdfCanvas {
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                    background-color: white;
                    max-width: 100%;
                }
                
                .loading-spinner {
                    position: absolute;
                    inset: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background-color: rgba(255, 255, 255, 0.8);
                    z-index: 10;
                }
                
                .spinner {
                    width: 3rem;
                    height: 3rem;
                    border-radius: 50%;
                    border: 0.25rem solid #f3f4f6;
                    border-top-color: #7c3aed;
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
                
                /* Page controls */
                .page-controls {
                    position: fixed;
                    bottom: 2rem;
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: white;
                    border-radius: 9999px;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                    padding: 0.5rem;
                    display: flex;
                    align-items: center;
                    z-index: 20;
                }
                
                .btn-icon {
                    background-color: transparent;
                    color: #7c3aed;
                    width: 2rem;
                    height: 2rem;
                    border-radius: 9999px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .btn-icon:hover {
                    background-color: #f5f3ff;
                    color: #5b21b6;
                }
                
                .btn-icon:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                .page-info {
                    margin: 0 0.5rem;
                    display: flex;
                    align-items: center;
                }
                
                .current-page {
                    font-size: 0.875rem;
                    font-weight: 500;
                    color: #5b21b6;
                }
                
                .page-divider {
                    margin: 0 0.25rem;
                    color: #9ca3af;
                }
                
                .total-pages {
                    font-size: 0.875rem;
                    color: #6b7280;
                }
                
                .divider {
                    width: 1px;
                    height: 1.5rem;
                    background-color: #e5e7eb;
                    margin: 0 0.5rem;
                }
                
                .zoom-level {
                    font-size: 0.875rem;
                    margin: 0 0.5rem;
                }
                
                /* Signature elements */
                .draggable {
                    position: absolute;
                    cursor: move;
                    z-index: 10;
                    transition: transform 0.1s ease;
                }
                
                .draggable.dragging {
                    opacity: 0.8;
                    z-index: 20;
                }
                
                .draggable.resizing {
                    opacity: 0.8;
                    z-index: 20;
                }
                
                .signature-image {
                    max-width: none; /* Override any max-width constraints */
                    display: block;
                    user-select: none;
                    margin: 0;
                    padding: 0;
                }
                
                .date-element {
                    background-color: white;
                    padding: 0.5rem 0.75rem;
                    border: 2px solid #c4b5fd;
                    border-radius: 0.375rem;
                    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                    color: #0c021a;
                text-align: center;
                    user-select: none;
                }
                
                /* Signature Pad Modal */
                .signature-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 50;
                    display: none;
                }
                
                .signature-modal-content {
                    background: linear-gradient(135deg, #f5f3ff 0%, #dbeafe 100%);
                    border-radius: 0.5rem;
                    width: 100%;
                    max-width: 32rem;
                    padding: 1.5rem;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    border: 2px solid #c4b5fd;
                }
                
                .signature-modal-title {
                    font-size: 1.25rem;
                    font-weight: 500;
                    color: #7c3aed;
                    margin-top: 0;
                    margin-bottom: 0.5rem;
                }
                
                .signature-modal-description {
                    color: #6d28d9;
                    margin-bottom: 1rem;
                }
                
                .signature-canvas {
                    width: 100%;
                    height: 200px;
                    border: 2px solid #c4b5fd;
                    border-radius: 0.375rem;
                    background-color: white;
                    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                }
                
                .signature-actions {
                    display: flex;
                    justify-content: space-between;
                    margin-top: 1rem;
                }
                
                .btn-outline {
                    background-color: transparent;
                    border: 1px solid #c4b5fd;
                    color: #7c3aed;
                    padding: 0.5rem 1rem;
                    border-radius: 0.375rem;
                }
                
                .btn-outline:hover {
                    background-color: #f5f3ff;
                }
                
                .signature-buttons {
                    display: flex;
                    gap: 0.5rem;
                }
                
                /* Enhanced Signature Features */
                .signature-tabs {
                    display: flex;
                    border-bottom: 1px solid #e5e7eb;
                    margin-bottom: 1rem;
                }
                
                .signature-tab {
                    padding: 0.5rem 1rem;
                    cursor: pointer;
                    font-size: 0.875rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    border-bottom: 2px solid transparent;
                }
                
                .signature-tab.active {
                    color: #7c3aed;
                    border-bottom: 2px solid #7c3aed;
                }
                
                .signature-tab-content {
                    display: none;
                }
                
                .signature-tab-content.active {
                    display: block;
                }
                
                .color-options {
                    display: flex;
                    justify-content: center;
                    margin-bottom: 1rem;
                    gap: 0.5rem;
                }
                
                .color-option {
                    width: 1.5rem;
                    height: 1.5rem;
                    border-radius: 9999px;
                    cursor: pointer;
                    transition: transform 0.2s;
                }
                
                .color-option:hover {
                    transform: scale(1.1);
                }
                
                .color-option.selected {
                    box-shadow: 0 0 0 2px white, 0 0 0 4px #7c3aed;
                }
                
                .signature-type-input {
                    width: 95%;
                    padding: 0.75rem;
                    border: 2px solid #c4b5fd;
                    border-radius: 0.375rem;
                    margin-bottom: 1rem;
                    font-size: 1rem;
                }
                
                .font-options {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 0.5rem;
                    max-height: 200px;
                    overflow-y: auto;
                    margin-bottom: 1rem;
                }
                
                .font-option {
                    padding: 0.75rem;
                    border: 1px solid #e5e7eb;
                    border-radius: 0.375rem;
                    cursor: pointer;
                    text-align: center;
                    background-color: white;
                }
                
                .font-option.selected {
                    border-color: #7c3aed;
                    background-color: #f5f3ff;
                }
                
                .upload-area {
                    border: 2px dashed #c4b5fd;
                    border-radius: 0.375rem;
                    padding: 2rem 1rem;
                    text-align: center;
                    background-color: white;
                    cursor: pointer;
                }
                
                .upload-area:hover {
                    background-color: #f5f3ff;
                }
                
                .camera-area {
                    border: 2px dashed #c4b5fd;
                    border-radius: 0.375rem;
                    padding: 2rem 1rem;
                    text-align: center;
                    background-color: white;
                }
                
                .signature-menu {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    margin-top: 0.25rem;
                    background-color: white;
                    border-radius: 0.5rem;
                    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    width: 280px;
                    z-index: 50;
                    border: 1px solid #e5e7eb;
                    display: none;
                    overflow: hidden;
                    animation: fadeIn 0.2s ease;
                }

                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }

                .signature-menu-item {
                    display: flex;
                    align-items: center;
                    padding: 0.75rem;
                    cursor: pointer;
                    border-bottom: 1px solid #f3f4f6;
                    transition: background-color 0.2s ease;
                }

                .signature-menu-item:hover {
                    background-color: #f5f3ff;
                }

                .signature-menu-item img {
                    height: 2.5rem;
                    margin-right: 0.75rem;
                    border: 1px solid #e5e7eb;
                    padding: 2px;
                    background-color: white;
                }

                .signature-menu-item .delete-btn {
                    margin-left: auto;
                    color: #9ca3af;
                    padding: 0.25rem;
                    border-radius: 9999px;
                    opacity: 0.7;
                    transition: all 0.2s ease;
                }

                .signature-menu-item .delete-btn:hover {
                    background-color: #fee2e2;
                    color: #ef4444;
                    opacity: 1;
                }

                .signature-menu-divider {
                    height: 1px;
                    background-color: #e5e7eb;
                    margin: 0.5rem 0;
                }

                .signature-menu-action {
                    display: flex;
                    align-items: center;
                    padding: 0.75rem;
                    cursor: pointer;
                    color: #7c3aed;
                    font-weight: 500;
                    transition: background-color 0.2s ease;
                }

                .signature-menu-action:hover {
                    background-color: #f5f3ff;
                }

                .signature-menu-action svg {
                    margin-right: 0.75rem;
                    width: 1.25rem;
                    height: 1.25rem;
                }
                
                .signature-save-checkbox {
                    display: flex;
                    align-items: center;
                    margin-top: 1rem;
                }
                
                .signature-save-checkbox input {
                    margin-right: 0.5rem;
                }
                
                .signature-element-controls {
                    position: absolute;
                    top: -1.5rem;
                    right: -1.5rem;
                    background-color: white;
                    border-radius: 9999px;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                    display: none;
                    transition: all 0.2s ease;
                    z-index: 25;
                }

                .draggable:hover .signature-element-controls {
                    display: block;
                }

                .signature-element-delete {
                    width: 1.5rem;
                    height: 1.5rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #ef4444;
                    cursor: pointer;
                    border-radius: 9999px;
                    transition: all 0.2s ease;
                }

                .signature-element-delete:hover {
                    background-color: #fee2e2;
                    transform: scale(1.1);
                }
                
                .signature-list {
                    max-height: 200px;
                    overflow-y: auto;
                }
                
                .signature-list-empty {
                    text-align: center;
                    padding: 1rem;
                    color: #6b7280;
                }
                
                /* Utility classes */
                .hidden {
                    display: none;
                }
                
                .ml-auto {
                    margin-left: auto;
                }
                
                .relative {
                    position: relative;
                }
                
                /* SVG icons */
                .icon {
                    display: inline-block;
                    vertical-align: middle;
                }
                
                /* Responsive adjustments */
                @media (max-width: 640px) {
                    .header {
                        padding: 1rem;
                    }
                    
                    .header-title {
                        font-size: 1.5rem;
                    }
                    
                    .upload-section {
                        padding: 1.5rem;
                    }
                    
                    .btn-primary {
                        padding: 0.75rem 1.5rem;
                    }
                    
                    .editor-toolbar {
                        flex-direction: column;
                        align-items: stretch;
                    }
                    
                    .toolbar-actions {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 0.5rem;
                        margin-bottom: 0.5rem;
                    }
                    
                    .toolbar-buttons {
                        display: flex;
                        justify-content: space-between;
                    }
                    
                    .page-controls {
                        flex-wrap: wrap;
                        justify-content: center;
                        padding: 0.5rem;
                    }
                    
                    .signature-tabs {
                        overflow-x: auto;
                    }
                }

                /* Resize handles for signatures */
                .resize-handle {
                    position: absolute;
                    width: 10px;
                    height: 10px;
                    background-color: #2563eb;
                    border: 1px solid white;
                    border-radius: 2px;
                    z-index: 20;
                    opacity: 0;
                    transition: opacity 0.2s ease;
                }

                .draggable:hover .resize-handle {
                    opacity: 1;
                }

                .resize-handle-nw {
                    cursor: nwse-resize;
                    top: -5px;
                    left: -5px;
                }

                .resize-handle-ne {
                    cursor: nesw-resize;
                    top: -5px;
                    right: -5px;
                }

                .resize-handle-sw {
                    cursor: nesw-resize;
                    bottom: -5px;
                    left: -5px;
                }

                .resize-handle-se {
                    cursor: nwse-resize;
                    bottom: -5px;
                    right: -5px;
                }

                /* Make sure signatures are properly displayed */
                .draggable img {
                    max-width: none; /* Override any max-width constraints */
                    display: block;
                    user-select: none;
                }

                .draggable {
                    position: absolute;
                    cursor: move;
                    z-index: 10;
                    transition: transform 0.1s ease;
                }

                .draggable:hover {
                    z-index: 15;
                }

                .draggable:active {
                    transform: scale(1.02);
                }
                
                .date-element {
                    background-color: white;
                    padding: 0.5rem 0.75rem;
                    border: 2px solid #c4b5fd;
                    border-radius: 0.375rem;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    color: #0c021a;
                    font-weight: 500;
                    min-width: 100px;
                    text-align: center;
                    user-select: none;
                }

                /* Date Picker Modal */
                .date-picker-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 50;
                    display: none;
                }

                .date-picker-modal-content {
                    background: linear-gradient(135deg, #f5f3ff 0%, #dbeafe 100%);
                    border-radius: 0.5rem;
                    width: 100%;
                    max-width: 32rem;
                    padding: 1.5rem;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    border: 2px solid #c4b5fd;
                }

                .calendar-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 1rem;
                }

                .calendar-navigation {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }

                .calendar-month-year {
                    font-size: 1.25rem;
                    font-weight: 500;
                    color: #7c3aed;
                }

                .calendar-grid {
                    display: grid;
                    grid-template-columns: repeat(7, 1fr);
                    gap: 0.25rem;
                    margin-bottom: 1rem;
                }

                .calendar-day-name,
                .calendar-day {
                    padding: 0.5rem;
                    text-align: center;
                    font-size: 0.875rem;
                }

                .calendar-day-name {
                    font-weight: 500;
                    color: #6b7280;
                }

                .calendar-day {
                    cursor: pointer;
                    border-radius: 0.375rem;
                    background-color: white;
                    color: #5b21b6;
                }

                .calendar-day:hover {
                    background-color: #f5f3ff;
                }

                .calendar-day.today {
                    background-color: #e0e7ff;
                    font-weight: 500;
                }

                .calendar-day.selected {
                    background-color: #7c3aed;
                    color: white;
                }

                .calendar-day.other-month {
                    color: #d1d5db;
                }

                .date-format-options {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                    margin-bottom: 1rem;
                }

                .date-format-option {
                    display: flex;
                    align-items: center;
                    padding: 0.5rem;
                    border: 1px solid #e5e7eb;
                    border-radius: 0.375rem;
                    cursor: pointer;
                   
                }

                .date-format-option:hover {
                    background-color: #f5f3ff;
                }

                .date-format-option.selected {
                    border-color: #7c3aed;
                    background-color: #f5f3ff;
                }

                .date-format-option input {
                    margin-right: 0.5rem;
                }

                .date-format-option label {
                    flex: 1;
                    font-size: 0.875rem;
                    color: #4b5563;
                }

                .date-format-option span {
                    font-size: 0.875rem;
                    color: #5b21b6;
                }

                /* Add this to your CSS section */
                @media (max-width: 768px) {
                    .resize-handle {
                        width: 16px;
                        height: 16px;
                        border-radius: 3px;
                    }
                    
                    .draggable:hover .resize-handle,
                    .draggable:active .resize-handle,
                    .draggable.dragging .resize-handle,
                    .draggable.resizing .resize-handle {
                        opacity: 1;
                    }
                    
                    .signature-element-controls {
                        top: -2rem;
                        right: -2rem;
                    }
                    
                    .signature-element-delete {
                        width: 2rem;
                        height: 2rem;
                    }
                }
            </style>
        </head>
        <body>
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <h1 class="header-title">
                        JunoSign
                    </h1>
                </div>
            </header>
            
            <!-- Main content -->
            <main class="container">
                <!-- File upload section -->
                <div id="uploadSection" class="upload-section">
                    <div class="upload-icon-container">
                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                    </div>
                    <h2 class="upload-title">Upload your PDF file</h2>
                    <p class="upload-subtitle">Drag and drop or click to browse</p>
                    <input type="file" id="fileInput" accept=".pdf" class="hidden" />
                    <button id="chooseFileBtn" class="btn btn-primary">Choose File</button>
                </div>
                
                <!-- PDF Editor -->
                <div id="editorSection" class="editor-section">
                    <!-- Toolbar -->
                    <div class="editor-toolbar" style="justify-content: space-between;">
                        <div class="toolbar-actions">
                            <div class="relative">
                                <button id="signatureMenuBtn" class="btn btn-toolbar" onclick="openSignaturePad('signature')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                    Sign
                                </button>
                                 <button id="signatureMenuBtn" class="btn btn-toolbar" onclick="addDate()">
                                    <!--<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>-->
                                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                      <line x1="16" y1="2" x2="16" y2="6"/>
                                      <line x1="8" y1="2" x2="8" y2="6"/>
                                      <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    Date
                                </button>
                                
                                
                                <!-- Signature Menu -->
                                <div id="signatureMenu" class="signature-menu">
                                    <div id="savedSignaturesList" class="signature-list">
                                        
                                    </div>
                                    
                                    <div id="noSavedSignatures" class="signature-list-empty">
                                       
                                    </div>
                                    
                                    <div class="signature-menu-divider"></div>
                                    
                                    <div class="signature-menu-action">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        New Signature
                                    </div>
                                    
                                    <!--<div class="signature-menu-action" onclick="openSignaturePad('initials')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 11.08V8l-6-6H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h6" />
                                            <path d="M14 3v5h5M18 21v-6M15 18h6" />
                                        </svg>
                                        Add Initials
                                    </div>-->
                                    
                                   <!-- <div class="signature-menu-action" onclick="addDate()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                                            <line x1="16" y1="2" x2="16" y2="6" />
                                            <line x1="8" y1="2" x2="8" y2="6" />
                                            <line x1="3" y1="10" x2="21" y2="10" />
                                        </svg>
                                        Add Date
                                    </div>-->
                                </div>
                            </div>
                        </div>
                        <div class="toolbar-buttons" style="display: flex;">
                            <button id="cancelBtn" class="btn btn-cancel">Cancel</button>
                            <button id="saveBtn" class="btn btn-save">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="mr-2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                Save PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- PDF Viewer -->
                    <div id="pdfContainer" class="pdf-container">
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                        
                        <div id="pdfCanvasContainer" class="pdf-canvas-container hidden">
                            <canvas id="pdfCanvas"></canvas>
                        </div>
                        
                        <!-- Page controls -->
                        <div class="page-controls">
                            <button id="prevPageBtn" class="btn btn-icon" disabled = "disabled">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="m15 18-6-6 6-6" />
                                </svg>
                            </button>
                            
                            <div class="page-info">
                                <span id="currentPage" class="current-page">1</span>
                                <span class="page-divider">/</span>
                                <span id="totalPages" class="total-pages">1</span>
                            </div>
                            
                            <button id="nextPageBtn" class="btn btn-icon" disabled = "disabled">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="m9 18 6-6-6-6" />
                                </svg>
                            </button>
                            
                            <div class="divider"></div>
                            
                            <button id="zoomOutBtn" class="btn btn-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <circle cx="11" cy="11" r="8" />
                                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                    <line x1="8" y1="11" x2="14" y2="11" />
                                </svg>
                            </button>
                            
                            <span id="zoomLevel" class="zoom-level">100%</span>
                            
                            <button id="zoomInBtn" class="btn btn-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <circle cx="11" cy="11" r="8" />
                                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                    <line x1="11" y1="8" x2="11" y2="14" />
                                    <line x1="8" y1="11" x2="14" y2="11" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Signature Pad Modal -->
                <div id="signatureModal" class="signature-modal">
                    <div class="signature-modal-content">
                        <h3 id="signatureModalTitle" class="signature-modal-title">Add Your Signature</h3>
                        <p class="signature-modal-description">Choose how you want to add your signature</p>
                        
                        <!-- Signature Tabs -->
                        <div class="signature-tabs">
                            <div class="signature-tab active" data-tab="draw">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                    <polyline points="10 17 15 12 10 7"></polyline>
                                    <line x1="15" y1="12" x2="3" y2="12"></line>
                                </svg>
                                Draw
                            </div>
                            <div class="signature-tab" data-tab="type">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <polyline points="4 7 4 4 20 4 20 7"></polyline>
                                    <line x1="9" y1="20" x2="15" y2="20"></line>
                                    <line x1="12" y1="4" x2="12" y2="20"></line>
                                </svg>
                                Type
                            </div>
                            <div class="signature-tab" data-tab="upload">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Upload
                            </div>
                            <div class="signature-tab" data-tab="camera">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                                Camera
                            </div>
                        </div>
                        
                        <!-- Color Options -->
                        <div class="color-options">
                            <div class="color-option selected" data-color="#000000" style="background-color: #000000;"></div>
                            <div class="color-option" data-color="#4285F4" style="background-color: #4285F4;"></div>
                            <div class="color-option" data-color="#19479D" style="background-color: #19479D;"></div>
                            <div class="color-option" data-color="#673AB7" style="background-color: #673AB7;"></div>
                            <div class="color-option" data-color="#777777" style="background-color: #777777;"></div>
                            <div class="color-option" data-color="#444444" style="background-color: #444444;"></div>
                        </div>
                        
                        <!-- Draw Tab Content -->
                        <div class="signature-tab-content active" id="drawTab">
                            <p class="text-center" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Sign your name using your mouse or touchpad.</p>
                            <div class="relative">
                                <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                                <button id="clearDrawingBtn" style="position: absolute; top: 0.5rem; right: 0.5rem; background-color: white; border-radius: 9999px; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Type Tab Content -->
                        <div class="signature-tab-content" id="typeTab">
                            <input type="text" id="typedSignature" class="signature-type-input" placeholder="Type your name" />
                            
                            <div class="font-options">
                                <div class="font-option selected" data-font="Dancing Script">
                                    <span style="font-family: 'Dancing Script'; font-size: 1.5rem;">Your Name</span>
                                </div>
                                <div class="font-option" data-font="Homemade Apple">
                                    <span style="font-family: 'Homemade Apple'; font-size: 1.25rem;">Your Name</span>
                                </div>
                                <div class="font-option" data-font="Caveat">
                                    <span style="font-family: 'Caveat'; font-size: 1.5rem;">Your Name</span>
                                </div>
                                <div class="font-option" data-font="Kalam">
                                    <span style="font-family: 'Kalam'; font-size: 1.5rem;">Your Name</span>
                                </div>
                                <div class="font-option" data-font="Parisienne">
                                    <span style="font-family: 'Parisienne'; font-size: 1.5rem;">Your Name</span>
                                </div>
                                <div class="font-option" data-font="Sacramento">
                                    <span style="font-family: 'Sacramento'; font-size: 1.5rem;">Your Name</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Tab Content -->
                        <div class="signature-tab-content" id="uploadTab">
                            <div class="upload-area" id="uploadArea">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style="margin: 0 auto 1rem; color: #7c3aed;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <p style="margin-bottom: 0.5rem; color: #6b7280;">Upload an image of your signature</p>
                                <button class="btn btn-outline">Select Image</button>
                                <input type="file" id="signatureUpload" accept="image/*" style="display: none;" />
                            </div>
                        </div>
                        
                        <!-- Camera Tab Content -->
                        <div class="signature-tab-content" id="cameraTab">
                            <div class="camera-area">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style="margin: 0 auto 1rem; color: #7c3aed;">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                                <p style="margin-bottom: 0.5rem; color: #6b7280;">Take a photo of your signature</p>
                                <button class="btn btn-outline" id="openCameraBtn">Open Camera</button>
                                <video id="cameraPreview" style="display: none; width: 100%; margin-top: 1rem;"></video>
                                <canvas id="cameraCanvas" style="display: none;"></canvas>
                            </div>
                        </div>
                        
                        <!-- Save Signature Checkbox -->
                        <div class="signature-save-checkbox">
                            <input type="checkbox" id="saveSignatureCheckbox" checked = "checked"/>
                            <label for="saveSignatureCheckbox" style="font-size: 0.875rem; color: #4b5563;">Save signature</label>
                        </div>
                        
                        <div class="signature-actions">
                            <div>
                                <button id="clearSignatureBtn" class="btn btn-outline">Clear</button>
                            </div>
                            <div class="signature-buttons">
                                <button id="cancelSignatureBtn" class="btn btn-outline">Cancel</button>
                                <button id="saveSignatureBtn" class="btn btn-primary">Add to Document</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Saved Signatures Modal -->
                <div id="savedSignaturesModal" class="signature-modal">
                    <div class="signature-modal-content">
                        <h3 class="signature-modal-title">Saved Signatures</h3>
                        <p class="signature-modal-description">Select a signature to use</p>
                        
                        <div id="savedSignaturesContainer" class="signature-list">
                            <!-- Saved signatures will be populated here -->
                        </div>
                        
                        <div class="signature-actions">
                            <button id="backToSignatureBtn" class="btn btn-outline">Back</button>
                            <button id="closeSavedSignaturesBtn" class="btn btn-outline">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Date Picker Modal -->
                <div id="datePickerModal" class="date-picker-modal">
                    <div class="date-picker-modal-content">
                        <h3 class="signature-modal-title">Select Date</h3>
                        <div class="calendar-header">
                            <div class="calendar-navigation">
                                <button id="prevMonthBtn" class="btn btn-outline">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="m15 18-6-6 6-6" />
                                    </svg>
                                </button>
                                <span id="calendarMonthYear" class="calendar-month-year"></span>
                                <button id="nextMonthBtn" class="btn btn-outline">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="m9 18 6-6-6-6" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="calendarDays" class="calendar-grid">
                            <!-- Calendar days will be populated here -->
                        </div>
                        <div class="date-format-options">
                            <div class="date-format-option selected" data-format="MM/DD/YYYY">
                                <input type="radio" name="dateFormat" checked="checked" />
                                <label>MM/DD/YYYY</label>
                                <span id="formatPreview1"></span>
                            </div>
                            <div class="date-format-option" data-format="DD/MM/YYYY">
                                <input type="radio" name="dateFormat" />
                                <label>DD/MM/YYYY</label>
                                <span id="formatPreview2"></span>
                            </div>
                            <div class="date-format-option" data-format="YYYY/MM/DD">
                                <input type="radio" name="dateFormat" />
                                <label>YYYY/MM/DD</label>
                                <span id="formatPreview3"></span>
                            </div>
                            <div class="date-format-option" data-format="MMM DD, YYYY">
                                <input type="radio" name="dateFormat" />
                                <label>MMM DD, YYYY</label>
                                <span id="formatPreview4"></span>
                            </div>
                        </div>
                        <div class="signature-actions">
                            <button id="cancelDateBtn" class="btn btn-outline">Cancel</button>
                            <button id="addSelectedDateBtn" class="btn btn-primary">Add Date</button>
                        </div>
                    </div>
                </div>
            </main>
            
            <script>
                // Initialize PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Initialize variables
                let pdfDocument = null;
                let currentPage = 1;
                let totalPages = 0;
                let scale = 1.0;
                let signaturePad = null;
                let currentSignatureType = 'signature'; // 'signature' or 'initials'
                let signatures = [];
                let savedSignatures = [];
                let selectedColor = '#000000';
                let selectedFont = 'Dancing Script';
                let activeTab = 'draw';
                let isSignatureMenuOpen = false;

                // Date picker variables
                let selectedDate = new Date();
                let currentCalendarDate = new Date();
                let selectedDateFormat = 'MM/DD/YYYY';
                
                // DOM elements
                const fileInput = document.getElementById('fileInput');
                const chooseFileBtn = document.getElementById('chooseFileBtn');
                const uploadSection = document.getElementById('uploadSection');
                const editorSection = document.getElementById('editorSection');
                const pdfCanvas = document.getElementById('pdfCanvas');
                const pdfCanvasContainer = document.getElementById('pdfCanvasContainer');
                const loadingSpinner = document.getElementById('loadingSpinner');
                const currentPageEl = document.getElementById('currentPage');
                const totalPagesEl = document.getElementById('totalPages');
                const prevPageBtn = document.getElementById('prevPageBtn');
                const nextPageBtn = document.getElementById('nextPageBtn');
                const zoomInBtn = document.getElementById('zoomInBtn');
                const zoomOutBtn = document.getElementById('zoomOutBtn');
                const zoomLevelEl = document.getElementById('zoomLevel');
                const saveBtn = document.getElementById('saveBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                const pdfContainer = document.getElementById('pdfContainer');
                
                // Signature elements
                const signatureModal = document.getElementById('signatureModal');
                const signatureCanvas = document.getElementById('signatureCanvas');
                const signatureModalTitle = document.getElementById('signatureModalTitle');
                const signatureMenuBtn = document.getElementById('signatureMenuBtn');
                const signatureMenu = document.getElementById('signatureMenu');
                const savedSignaturesList = document.getElementById('savedSignaturesList');
                const noSavedSignatures = document.getElementById('noSavedSignatures');
                const clearSignatureBtn = document.getElementById('clearSignatureBtn');
                const cancelSignatureBtn = document.getElementById('cancelSignatureBtn');
                const saveSignatureBtn = document.getElementById('saveSignatureBtn');
                const saveSignatureCheckbox = document.getElementById('saveSignatureCheckbox');
                const clearDrawingBtn = document.getElementById('clearDrawingBtn');
                const typedSignature = document.getElementById('typedSignature');
                const signatureTabs = document.querySelectorAll('.signature-tab');
                const signatureTabContents = document.querySelectorAll('.signature-tab-content');
                const colorOptions = document.querySelectorAll('.color-option');
                const fontOptions = document.querySelectorAll('.font-option');
                const uploadArea = document.getElementById('uploadArea');
                const signatureUpload = document.getElementById('signatureUpload');
                const openCameraBtn = document.getElementById('openCameraBtn');
                const cameraPreview = document.getElementById('cameraPreview');
                const cameraCanvas = document.getElementById('cameraCanvas');

                // Date picker elements
                const datePickerModal = document.getElementById('datePickerModal');
                const calendarMonthYear = document.getElementById('calendarMonthYear');
                const calendarDays = document.getElementById('calendarDays');
                const prevMonthBtn = document.getElementById('prevMonthBtn');
                const nextMonthBtn = document.getElementById('nextMonthBtn');
                const cancelDateBtn = document.getElementById('cancelDateBtn');
                const addSelectedDateBtn = document.getElementById('addSelectedDateBtn');
                const dateFormatOptions = document.querySelectorAll('.date-format-option');
                const formatPreviews = document.querySelectorAll('[id^="formatPreview"]');
                
                // Initialize event listeners
                document.addEventListener('DOMContentLoaded', function() {
                    // Load saved signatures
                    loadSavedSignatures();
                    
                    // Ensure proper initial display
                    uploadSection.style.display = 'block';
                    editorSection.style.display = 'none';
                    
                    // File upload
                    chooseFileBtn.addEventListener('click', function() {
                        fileInput.click();
                    });
                    
                    fileInput.addEventListener('change', handleFileUpload);
                    
                    // PDF navigation
                    prevPageBtn.addEventListener('click', prevPage);
                    nextPageBtn.addEventListener('click', nextPage);
                    zoomInBtn.addEventListener('click', zoomIn);
                    zoomOutBtn.addEventListener('click', zoomOut);
                    
                    // Signature menu
                    signatureMenuBtn.addEventListener('click', toggleSignatureMenu);
                    
                    // Close signature menu when clicking outside
                    document.addEventListener('click', function(e) {
                        if (isSignatureMenuOpen && !signatureMenu.contains(e.target) && e.target !== signatureMenuBtn) {
                            closeSignatureMenu();
                        }
                    });
                    
                    // Signature tabs
                    signatureTabs.forEach(tab => {
                        tab.addEventListener('click', function() {
                            const tabName = this.getAttribute('data-tab');
                            switchSignatureTab(tabName);
                        });
                    });
                    
                    // Color options
                    colorOptions.forEach(option => {
                        option.addEventListener('click', function() {
                            selectedColor = this.getAttribute('data-color');
                            colorOptions.forEach(opt => opt.classList.remove('selected'));
                            this.classList.add('selected');
                            
                            // Update signature pad color if active
                            if (signaturePad && activeTab === 'draw') {
                                signaturePad.penColor = selectedColor;
                            }
                            
                            // Update typed signature color
                            updateTypedSignaturePreview();
                        });
                    });
                    
                    // Font options
                    fontOptions.forEach(option => {
                        option.addEventListener('click', function() {
                            selectedFont = this.getAttribute('data-font');
                            fontOptions.forEach(opt => opt.classList.remove('selected'));
                            this.classList.add('selected');
                            
                            // Update typed signature preview
                            updateTypedSignaturePreview();
                        });
                    });
                    
                    // Typed signature input
                    typedSignature.addEventListener('input', updateTypedSignaturePreview);
                    
                    // Upload area
                    uploadArea.addEventListener('click', function() {
                        signatureUpload.click();
                    });
                    
                    signatureUpload.addEventListener('change', handleSignatureImageUpload);
                    
                    // Camera button
                    openCameraBtn.addEventListener('click', openCamera);
                    
                    // Signature actions
                    clearDrawingBtn.addEventListener('click', clearSignature);
                    clearSignatureBtn.addEventListener('click', clearSignature);
                    cancelSignatureBtn.addEventListener('click', closeSignaturePad);
                    saveSignatureBtn.addEventListener('click', addSignatureToDocument);
                    
                    // Actions
                    saveBtn.addEventListener('click', savePDF);
                    cancelBtn.addEventListener('click', resetEditor);

                    // Date picker initialization
                    prevMonthBtn.addEventListener('click', () => {
                        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                        renderCalendar();
                    });

                    nextMonthBtn.addEventListener('click', () => {
                        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                        renderCalendar();
                    });

                    cancelDateBtn.addEventListener('click', () => {
                        datePickerModal.style.display = 'none';
                    });

                    addSelectedDateBtn.addEventListener('click', () => {
                        const formattedDate = formatDate(selectedDate, selectedDateFormat);
                        addDateToDocument(formattedDate);
                        datePickerModal.style.display = 'none';
                    });

                    dateFormatOptions.forEach(option => {
                        option.addEventListener('click', function() {
                            selectedDateFormat = this.getAttribute('data-format');
                            dateFormatOptions.forEach(opt => opt.classList.remove('selected'));
                            this.classList.add('selected');
                            updateFormatPreviews();
                        });
                    });
                    
                    // Initialize SignaturePad when the modal is opened
                        // initializeSignaturePad();
                    
                    // Make PDF container a drop zone for signatures
                    pdfContainer.addEventListener('dragover', handleDragOver);
                    pdfContainer.addEventListener('drop', handleDrop);
                });
                
                // Load saved signatures from localStorage
                function loadSavedSignatures() {
                    const savedSignaturesData = localStorage.getItem('savedSignatures');
                    if (savedSignaturesData) {
                        try {
                            savedSignatures = JSON.parse(savedSignaturesData);
                            updateSavedSignaturesList();
                        } catch (e) {
                            console.error('Error loading saved signatures:', e);
                            savedSignatures = [];
                        }
                    }
                }
                
                // Update the saved signatures list in the menu
                function updateSavedSignaturesList() {
                    savedSignaturesList.innerHTML = '';
                    
                    if (savedSignatures.length > 0) {
                        noSavedSignatures.style.display = 'none';
                        savedSignaturesList.style.display = 'block';
                        
                        savedSignatures.forEach((sig, index) => {
                            const item = document.createElement('div');
                            item.className = 'signature-menu-item';
                            item.innerHTML = `
                                <img src="${sig}" alt="Signature ${index + 1}" />
                                <button class="delete-btn" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            `;
                            
                            // Add click event to use this signature
                            item.addEventListener('click', function(e) {
                                if (!e.target.closest('.delete-btn')) {
                                    useSavedSignature(sig);
                                }
                            });
                            
                            savedSignaturesList.appendChild(item);
                        });
                        
                        // Add delete button event listeners
                        document.querySelectorAll('.delete-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const index = Number.parseInt(this.getAttribute('data-index'));
                                deleteSavedSignature(index);
                            });
                        });
                    } else {
                        noSavedSignatures.style.display = 'block';
                        savedSignaturesList.style.display = 'none';
                    }
                }
                
                // Use a saved signature
                function useSavedSignature(signatureDataUrl) {
                    // Create a unique ID for this signature
                    const signatureId = 'sig-' + Date.now();
                    
                    // Create an image element
                    const signatureImg = document.createElement('img');
                    signatureImg.src = signatureDataUrl;
                    signatureImg.className = 'signature-image';
                    signatureImg.id = signatureId;
                    signatureImg.alt = 'Signature';
                    signatureImg.draggable = false; // Prevent default dragging
                    
                    // Position the signature in the center of the visible area
                    const pdfContainerRect = pdfContainer.getBoundingClientRect();
                    const centerX = pdfContainerRect.width / 2;
                    const centerY = pdfContainerRect.height / 2 - 50; // Slightly above center
                    
                    // Add delete control
                    const deleteControl = document.createElement('div');
                    deleteControl.className = 'signature-element-controls';
                    deleteControl.innerHTML = `
                        <div class="signature-element-delete" data-id="${signatureId}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </div>
                    `;
                    
                    // Create a wrapper for the signature and controls
                    const wrapper = document.createElement('div');
                    wrapper.className = 'draggable';
                    wrapper.id = 'wrapper-' + signatureId;
                    wrapper.style.left = `${centerX - 100}px`;
                    wrapper.style.top = `${centerY}px`;
                    wrapper.appendChild(signatureImg);
                    wrapper.appendChild(deleteControl);
                    
                    // Make the wrapper draggable and resizable
                    makeDraggable(wrapper);
                    
                    // Add to editor
                    pdfContainer.appendChild(wrapper);
                    
                    // Add to signatures array
                    signatures.push({
                        id: signatureId,
                        type: 'signature',
                        element: wrapper,
                        dataUrl: signatureDataUrl
                    });
                    
                    // Add delete event listener
                    deleteControl.querySelector('.signature-element-delete').addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteSignature(id);
                    });
                    
                    // Add a subtle animation effect
                    wrapper.style.opacity = '0';
                    setTimeout(() => {
                        wrapper.style.transition = 'opacity 0.3s ease';
                        wrapper.style.opacity = '1';
                    }, 10);
                    
                    // Close the menu
                    closeSignatureMenu();
                }
                
                // Delete a saved signature
                function deleteSavedSignature(index) {
                    savedSignatures.splice(index, 1);
                    localStorage.setItem('savedSignatures', JSON.stringify(savedSignatures));
                    updateSavedSignaturesList();
                }
                
                // Delete a signature from the document
                function deleteSignature(id) {
                    const wrapper = document.getElementById('wrapper-' + id);
                    if (wrapper) {
                        // Add removal animation
                        wrapper.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        wrapper.style.opacity = '0';
                        wrapper.style.transform += ' scale(0.9)';
                        
                        // Remove after animation completes
                        setTimeout(() => {
                            wrapper.remove();
                        }, 300);
                    }
                    
                    signatures = signatures.filter(sig => sig.id !== id);
                }
                
                // Toggle signature menu
                function toggleSignatureMenu() {
                    if (isSignatureMenuOpen) {
                        closeSignatureMenu();
                    } else {
                        openSignatureMenu();
                    }
                }
                
                // Open signature menu
                function openSignatureMenu() {
                    signatureMenu.style.display = 'block';
                    isSignatureMenuOpen = true;
                }
                
                // Close signature menu
                function closeSignatureMenu() {
                    signatureMenu.style.display = 'none';
                    isSignatureMenuOpen = false;
                }
                
                // Switch signature tab
                function switchSignatureTab(tabName) {
                    activeTab = tabName;
                    
                    // Update tab UI
                    signatureTabs.forEach(tab => {
                        if (tab.getAttribute('data-tab') === tabName) {
                            tab.classList.add('active');
                        } else {
                            tab.classList.remove('active');
                        }
                    });
                    
                    // Update content UI
                    signatureTabContents.forEach(content => {
                        if (content.id === tabName + 'Tab') {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                    
                    // Initialize signature pad if draw tab is active
                    if (tabName === 'draw') {
                        setTimeout(() => {
                            initializeSignaturePad();
                        }, 100);
                    }
                }
                
                // Update typed signature preview
                function updateTypedSignaturePreview() {
                    const name = typedSignature.value || 'Your Name';
                    
                    fontOptions.forEach(option => {
                        const font = option.getAttribute('data-font');
                        const preview = option.querySelector('span');
                        preview.textContent = name;
                        preview.style.color = selectedColor;
                    });
                }
                
                // Handle signature image upload
                function handleSignatureImageUpload(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = function(event) {
                            const img = new Image();
                            img.onload = function() {
                                // Create a canvas to resize and process the image
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // Set a reasonable size for the signature
                                const maxWidth = 400;
                                const maxHeight = 200;
                                let width = img.width;
                                let height = img.height;
                                
                                // Scale down if needed
                                if (width > maxWidth) {
                                    height = (height * maxWidth) / width;
                                    width = maxWidth;
                                }
                                if (height > maxHeight) {
                                    width = (width * maxHeight) / height;
                                    height = maxHeight;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                
                                // Draw white background
                        // ctx.fillStyle = 'white';
                        //ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Draw the image
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // Get the data URL
                                const dataUrl = canvas.toDataURL();
                                
                                // Save and use the signature
                                if (saveSignatureCheckbox.checked) {
                                    savedSignatures.push(dataUrl);
                                    localStorage.setItem('savedSignatures', JSON.stringify(savedSignatures));
                                    updateSavedSignaturesList();
                                }
                                
                                // Add to document
                                addSignatureImageToDocument(dataUrl);
                                
                                // Close modal
                                closeSignaturePad();
                            };
                            img.src = event.target.result.toString();
                        };
                        
                        reader.readAsDataURL(file);
                    }
                }
                
                // Open camera for signature capture
                function openCamera() {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then((stream) => {
                                cameraPreview.style.display = 'block';
                                openCameraBtn.textContent = 'Take Photo';
                                
                                cameraPreview.srcObject = stream;
                                cameraPreview.play();
                                
                                // Change button to take photo
                                openCameraBtn.removeEventListener('click', openCamera);
                                openCameraBtn.addEventListener('click', takePhoto);
                            })
                            .catch((error) => {
                                console.error('Camera error:', error);
                                alert('Could not access camera. Please check permissions or try another method.');
                            });
                    } else {
                        alert('Camera not supported in this browser. Please try another method.');
                    }
                }
                
                // Take photo from camera
                function takePhoto() {
                    const context = cameraCanvas.getContext('2d');
                    
                    // Set canvas dimensions to match video
                    cameraCanvas.width = cameraPreview.videoWidth;
                    cameraCanvas.height = cameraPreview.videoHeight;
                    
                    // Draw video frame to canvas
                    context.drawImage(cameraPreview, 0, 0, cameraCanvas.width, cameraCanvas.height);
                    
                    // Get data URL
                    const dataUrl = cameraCanvas.toDataURL('image/png');
                    
                    // Stop camera stream
                    const stream = cameraPreview.srcObject;
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    
                    // Reset UI
                    cameraPreview.style.display = 'none';
                    openCameraBtn.textContent = 'Open Camera';
                    openCameraBtn.removeEventListener('click', takePhoto);
                    openCameraBtn.addEventListener('click', openCamera);
                    
                    // Save and use the signature
                    if (saveSignatureCheckbox.checked) {
                        savedSignatures.push(dataUrl);
                        localStorage.setItem('savedSignatures', JSON.stringify(savedSignatures));
                        updateSavedSignaturesList();
                    }
                    
                    // Add to document
                    addSignatureImageToDocument(dataUrl);
                    
                    // Close modal
                    closeSignaturePad();
                }
                
                // Initialize signature pad
                function initializeSignaturePad() {
                    // Initialize only if not already initialized
                    if (!signaturePad && signatureCanvas) {
                        signaturePad = new SignaturePad(signatureCanvas, {
                            // backgroundColor: 'rgb(255, 255, 255)',
                            penColor: selectedColor
                        });
                        
                        // Resize canvas to fit container
                        resizeSignatureCanvas();
                        window.addEventListener('resize', resizeSignatureCanvas);
                    } else if (signaturePad) {
                        // Update pen color
                        signaturePad.penColor = selectedColor;
                    }
                }
                
                // Resize signature canvas
                function resizeSignatureCanvas() {
                    if (signatureCanvas && signaturePad) {
                        const ratio = Math.max(window.devicePixelRatio || 1, 1);
                        signatureCanvas.width = signatureCanvas.offsetWidth * ratio;
                        signatureCanvas.height = signatureCanvas.offsetHeight * ratio;
                        signatureCanvas.getContext("2d").scale(ratio, ratio);
                        signaturePad.clear(); // Clear the canvas
                    }
                }
                
                // Open signature pad modal
                function openSignaturePad(type) {
                    currentSignatureType = type;
                    signatureModal.style.display = 'flex';
                    
                    // Set the appropriate title
                    signatureModalTitle.textContent = type === 'signature' ? 'Add Your Signature' : 'Add Your Initials';
                    
                    // Reset to draw tab
                    switchSignatureTab('draw');
                    
                    // Clear any existing signature
                    clearSignature();
                    
                    // Initialize if not already done
                    setTimeout(() => {
                        initializeSignaturePad();
                    }, 100);
                    
                    // Close the menu
                    closeSignatureMenu();
                }
                
                // Close signature pad modal
                function closeSignaturePad() {
                    signatureModal.style.display = 'none';
                    
                    // Reset camera if active
                    if (cameraPreview.srcObject) {
                        const stream = cameraPreview.srcObject;
                        const tracks = stream.getTracks();
                        tracks.forEach(track => track.stop());
                        cameraPreview.style.display = 'none';
                        openCameraBtn.textContent = 'Open Camera';
                        openCameraBtn.removeEventListener('click', takePhoto);
                        openCameraBtn.addEventListener('click', openCamera);
                    }
                }
                
                // Clear signature
                function clearSignature() {
                    if (activeTab === 'draw' && signaturePad) {
                        signaturePad.clear();
                    } else if (activeTab === 'type') {
                        typedSignature.value = '';
                        updateTypedSignaturePreview();
                    }
                }
                
                // Add signature to document
                function addSignatureToDocument() {
                    let dataUrl = '';
                    
                    if (activeTab === 'draw') {
                        if (signaturePad && !signaturePad.isEmpty()) {
                            dataUrl = signaturePad.toDataURL();
                        } else {
                            alert('Please provide a signature first');
                            return;
                        }
                    } else if (activeTab === 'type') {
                        const name = typedSignature.value.trim();
                        if (!name) {
                            alert('Please type your name first');
                            return;
                        }
                        
                        // Create a canvas to render the typed signature
                        const canvas = document.createElement('canvas');
                        canvas.width = 400;
                        canvas.height = 150;
                        const ctx = canvas.getContext('2d');
                        
                        // Draw white background
                        // ctx.fillStyle = 'white';
                        // ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Set font and color
                        ctx.fillStyle = selectedColor;
                        ctx.font = `36px "${selectedFont}"`;
                        ctx.textBaseline = 'middle';
                        ctx.fillText(name, 20, canvas.height / 2);
                        
                        dataUrl = canvas.toDataURL();
                    } else {
                        // Upload and camera are handled by their own functions
                        return;
                    }
                    
                    if (dataUrl) {
                        // Save signature if checkbox is checked
                        if (saveSignatureCheckbox.checked) {
                            savedSignatures.push(dataUrl);
                            localStorage.setItem('savedSignatures', JSON.stringify(savedSignatures));
                            updateSavedSignaturesList();
                        }
                        
                        // Add to document
                        addSignatureImageToDocument(dataUrl);
                        
                        // Close modal
                        closeSignaturePad();
                    }
                }
                
                // Add signature image to document with improved positioning
               function addSignatureImageToDocument(dataUrl) {
    // Create a unique ID for this signature
    const signatureId = 'sig-' + Date.now();
    
    // Create an image element
    const signatureImg = document.createElement('img');
    signatureImg.src = dataUrl;
    signatureImg.className = 'signature-image';
    signatureImg.id = signatureId;
    signatureImg.alt = currentSignatureType === 'signature' ? 'Signature' : 'Initials';
    signatureImg.draggable = false; // Prevent default dragging
    
    // Determine device type based on viewport width
    const isMobile = window.innerWidth < 768;
    
    // Set initial width and height based on device type
    signatureImg.style.width = isMobile ? '80px' : '150px'; // Smaller on mobile, larger on PC
    signatureImg.style.height = isMobile ? '40px' : '75px'; // Smaller on mobile, larger on PC
    
    // Add delete control
    const deleteControl = document.createElement('div');
    deleteControl.className = 'signature-element-controls';
    deleteControl.innerHTML = `
        <div class="signature-element-delete" data-id="${signatureId}">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </div>
    `;
    
    // Get the center of the visible PDF area
    const pdfContainerRect = pdfContainer.getBoundingClientRect();
    const centerX = pdfContainerRect.width / 2;
    const centerY = pdfContainerRect.height / 2 - 50; // Slightly above center
    
    // Create a wrapper for the signature and controls
    const wrapper = document.createElement('div');
    wrapper.className = 'draggable';
    wrapper.id = 'wrapper-' + signatureId;
    wrapper.style.position = 'absolute';
    
    // Position in the center, adjusted for new dimensions
    const sigWidth = isMobile ? 80 : 150;
    const sigHeight = isMobile ? 40 : 75;
    wrapper.style.left = `${centerX - (sigWidth / 2)}px`; // Adjusted for new width
    wrapper.style.top = `${centerY - (sigHeight / 2)}px`; // Adjusted for new height
    
    wrapper.appendChild(signatureImg);
    wrapper.appendChild(deleteControl);
    
    // Make the wrapper draggable and resizable
    makeDraggable(wrapper);
    
    // Add to editor
    pdfContainer.appendChild(wrapper);
    
    // Add to signatures array
    signatures.push({
        id: signatureId,
        type: currentSignatureType,
        element: wrapper,
        dataUrl: dataUrl,
    });
    
    // Add delete event listener
    deleteControl.querySelector('.signature-element-delete').addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        deleteSignature(id);
    });
    
    // Add a subtle animation effect
    wrapper.style.opacity = '0';
    setTimeout(() => {
        wrapper.style.transition = 'opacity 0.3s ease';
        wrapper.style.opacity = '1';
    }, 10);
}
                
                // Add date to document
                function addDate() {
                    selectedDate = new Date();
                    currentCalendarDate = new Date();
                    selectedDateFormat = 'MM/DD/YYYY';
                    datePickerModal.style.display = 'flex';
                    renderCalendar();
                    updateFormatPreviews();
                    closeSignatureMenu();
                }

                // Render calendar for date picker
                function renderCalendar() {
                    calendarDays.innerHTML = '';

                    const year = currentCalendarDate.getFullYear();
                    const month = currentCalendarDate.getMonth();
                    calendarMonthYear.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

                    // Add day names
                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    dayNames.forEach(day => {
                        const dayElement = document.createElement('div');
                        dayElement.className = 'calendar-day-name';
                        dayElement.textContent = day;
                        calendarDays.appendChild(dayElement);
                    });

                    // Get first day of the month
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const prevMonthDays = new Date(year, month, 0).getDate();

                    // Add previous month's days
                    for (let i = firstDay - 1; i >= 0; i--) {
                        const dayElement = document.createElement('div');
                        dayElement.className = 'calendar-day other-month';
                        dayElement.textContent = prevMonthDays - i;
                        calendarDays.appendChild(dayElement);
                    }

                    // Add current month's days
                    const today = new Date();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayElement = document.createElement('div');
                        dayElement.className = 'calendar-day';
                        dayElement.textContent = day;

                        const currentDate = new Date(year, month, day);
                        if (currentDate.toDateString() === today.toDateString()) {
                            dayElement.classList.add('today');
                        }
                        if (currentDate.toDateString() === selectedDate.toDateString()) {
                            dayElement.classList.add('selected');
                        }

                        dayElement.addEventListener('click', () => {
                            selectedDate = new Date(year, month, day);
                            renderCalendar();
                            updateFormatPreviews();
                        });

                        calendarDays.appendChild(dayElement);
                    }

                    // Add next month's days to fill the grid
                    const totalDays = firstDay + daysInMonth;
                    const remainingDays = (7 - (totalDays % 7)) % 7;
                    for (let i = 1; i <= remainingDays; i++) {
                        const dayElement = document.createElement('div');
                        dayElement.className = 'calendar-day other-month';
                        dayElement.textContent = i;
                        calendarDays.appendChild(dayElement);
                    }
                }

                // Format date according to selected format
                function formatDate(date, format) {
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const monthName = monthNames[date.getMonth()];

                    switch (format) {
                        case 'MM/DD/YYYY':
                            return `${month}/${day}/${year}`;
                        case 'DD/MM/YYYY':
                            return `${day}/${month}/${year}`;
                        case 'YYYY/MM/DD':
                            return `${year}/${month}/${day}`;
                        case 'MMM DD, YYYY':
                            return `${monthName} ${day}, ${year}`;
                        default:
                            return date.toLocaleDateString();
                    }
                }

                // Update date format previews
                function updateFormatPreviews() {
                    formatPreviews.forEach(preview => {
                        const format = preview.parentElement.getAttribute('data-format');
                        preview.textContent = formatDate(selectedDate, format);
                    });
                }

                // Add formatted date to document
              function addDateToDocument(formattedDate) {
    // Create a unique ID for this date element
    const dateId = 'date-' + Date.now();
    
    // Create the date element
    const dateElement = document.createElement('div');
    dateElement.className = 'date-element';
    dateElement.id = dateId;
    dateElement.textContent = formattedDate;
    
    // Determine device type based on viewport width
    const isMobile = window.innerWidth < 768;
    
    // Set size based on device type
    dateElement.style.width = isMobile ? '60px' : '100px'; // Smaller on mobile, larger on PC
    dateElement.style.height = isMobile ? '20px' : '30px'; // Smaller on mobile, larger on PC
    dateElement.style.lineHeight = isMobile ? '20px' : '30px'; // Adjust line height to match height
    dateElement.style.fontSize = isMobile ? '10px' : '14px'; // Smaller font on mobile
    
    // Add delete control
    const deleteControl = document.createElement('div');
    deleteControl.className = 'signature-element-controls';
    deleteControl.innerHTML = `
        <div class="signature-element-delete" data-id="${dateId}">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </div>
    `;
    
    // Get the center of the visible PDF area
    const pdfContainerRect = pdfContainer.getBoundingClientRect();
    const centerX = pdfContainerRect.width / 2;
    const centerY = pdfContainerRect.height / 2 - 50; // Slightly above center
    
    // Create a wrapper for the date and controls
    const wrapper = document.createElement('div');
    wrapper.className = 'draggable';
    wrapper.id = 'wrapper-' + dateId;
    wrapper.style.position = 'absolute';
    
    // Position in the center, adjusted for new dimensions
    const dateWidth = isMobile ? 60 : 100;
    const dateHeight = isMobile ? 20 : 30;
    wrapper.style.left = `${centerX - (dateWidth / 2)}px`; // Adjusted for new width
    wrapper.style.top = `${centerY - (dateHeight / 2)}px`; // Adjusted for new height
    
    wrapper.appendChild(dateElement);
    wrapper.appendChild(deleteControl);
    
    // Make the wrapper draggable and resizable
    makeDraggable(wrapper);
    
    // Add to editor
    pdfContainer.appendChild(wrapper);
    
    // Add to signatures array (treating dates as a type of signature for management)
    signatures.push({
        id: dateId,
        type: 'date',
        element: wrapper,
        text: formattedDate
    });
    
    // Add delete event listener
    deleteControl.querySelector('.signature-element-delete').addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        deleteSignature(id);
    });
    
    // Add a subtle animation effect
    wrapper.style.opacity = '0';
    setTimeout(() => {
        wrapper.style.transition = 'opacity 0.3s ease';
        wrapper.style.opacity = '1';
    }, 10);
}
                
                // Handle file upload
                function handleFileUpload(e) {
                    if (e.target.files && e.target.files[0]) {
                        // Hide upload section immediately
                        uploadSection.style.display = 'none';
                        
                        // Show loading spinner
                        showLoading(true);
                        
                        const selectedFile = e.target.files[0];
                        loadPDF(selectedFile);
                    }
                }
                
                // Load PDF document
                function loadPDF(pdfFile) {
                    showLoading(true);
                    
                    const fileReader = new FileReader();
                    
                    fileReader.onload = async (event) => {
                        try {
                            const typedArray = new Uint8Array(event.target.result);
                            
                            // Load the PDF document
                            const loadingTask = pdfjsLib.getDocument({ data: typedArray });
                            const pdf = await loadingTask.promise;
                            
                            pdfDocument = pdf;
                            totalPages = pdf.numPages;
                            currentPage = 1;
                            
                            // Update UI
                            totalPagesEl.textContent = totalPages;
                            currentPageEl.textContent = currentPage;
                            
                            // Show editor section with flex display
                            editorSection.style.display = 'flex';
                            
                            // Render all pages instead of just the first one
                            renderAllPages(pdf, scale);
                        } catch (error) {
                            console.error("Error loading PDF:", error);
                            alert("Error loading PDF. Please try again with a different file.");
                            // If there's an error, go back to upload screen
                            uploadSection.style.display = 'block';
                            showLoading(false);
                        }
                    };
                    
                    fileReader.readAsArrayBuffer(pdfFile);
                }

                // Render all PDF pages
                async function renderAllPages(pdf, pageScale) {
                    if (!pdfCanvas) return;
                    
                    // Clear existing canvas container
                    pdfCanvasContainer.innerHTML = '';
                    
                    try {
                        showLoading(true);
                        
                        // Get total pages
                        totalPages = pdf.numPages;
                        totalPagesEl.textContent = totalPages;
                        
                        // Create and render each page
                        for (let pageNumber = 1; pageNumber <= totalPages; pageNumber++) {
                            const page = await pdf.getPage(pageNumber);
                            const viewport = page.getViewport({ scale: pageScale });
                            
                            // Create a new canvas for each page
                            const canvas = document.createElement('canvas');
                            canvas.className = 'pdf-page-canvas';
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            canvas.style.marginBottom = '20px';
                            canvas.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
                            canvas.style.backgroundColor = 'white';
                            
                            // Add page number indicator
                            const pageIndicator = document.createElement('div');
                            pageIndicator.className = 'page-indicator';
                            pageIndicator.textContent = `Page ${pageNumber} of ${totalPages}`;
                            pageIndicator.style.textAlign = 'center';
                            pageIndicator.style.marginBottom = '10px';
                            pageIndicator.style.fontWeight = '500';
                            pageIndicator.style.color = '#6b7280';
                            
                            // Create a wrapper for each page
                            const pageWrapper = document.createElement('div');
                            pageWrapper.className = 'pdf-page-wrapper';
                            pageWrapper.appendChild(pageIndicator);
                            pageWrapper.appendChild(canvas);
                            
                            // Add to container
                            pdfCanvasContainer.appendChild(pageWrapper);
                            
                            // Render the page
                            const context = canvas.getContext('2d');
                            const renderContext = { canvasContext: context, viewport: viewport };
                            await page.render(renderContext).promise;
                        }
                        
                        // Hide loading spinner
                        showLoading(false);
                        
                        // Since we're showing all pages, we don't need the page navigation controls
                        document.querySelector('.page-controls').style.display = 'none';
                        
                    } catch (error) {
                        console.error("Error rendering pages:", error);
                        showLoading(false);
                    }
                }
                
                // Show/hide loading spinner
                function showLoading(isLoading) {
                    if (isLoading) {
                        // Ensure canvas container is visible but overlay the spinner
                        pdfCanvasContainer.style.display = 'block';
                        loadingSpinner.style.display = 'flex';
                        // Do not add 'hidden' class to keep canvas measurable
                    } else {
                        loadingSpinner.style.display = 'none';
                        pdfCanvasContainer.classList.remove('hidden');
                    }
                }
                
                // Navigate to previous page
                function prevPage() {
                    if (currentPage > 1) {
                        currentPage--;
                        currentPageEl.textContent = currentPage;
                        renderPage(pdfDocument, currentPage, scale);
                        updateNavigationButtons();
                    }
                }
                
                // Navigate to next page
                function nextPage() {
                    if (currentPage < totalPages) {
                        currentPage++;
                        currentPageEl.textContent = currentPage;
                        renderPage(pdfDocument, currentPage, scale);
                        updateNavigationButtons();
                    }
                }
                
                // Update navigation buttons state
                function updateNavigationButtons() {
                    prevPageBtn.disabled = currentPage <= 1;
                    nextPageBtn.disabled = currentPage >= totalPages;
                }
                
                // Zoom in
                function zoomIn() {
                    scale += 0.2;
                    zoomLevelEl.textContent = Math.round(scale * 100) + '%';
                    renderAllPages(pdfDocument, scale);
                }

                // Zoom out
                function zoomOut() {
                    if (scale > 0.4) {
                        scale -= 0.2;
                        zoomLevelEl.textContent = Math.round(scale * 100) + '%';
                        renderAllPages(pdfDocument, scale);
                    }
                }
                
                // Make an element draggable and resizable with improved positioning
                function makeDraggable(element) {
                    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                    
                    // Add resize handles
                    addResizeHandles(element);
                    
                    element.onmousedown = dragMouseDown;
                    element.ontouchstart = dragTouchStart;
                    
                    function dragMouseDown(e) {
                        // Skip if clicking on a resize handle
                        if (e.target.classList.contains('resize-handle')) {
                            return;
                        }
                        
                        e.preventDefault();
                        // Get the mouse cursor position at startup
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        document.onmouseup = closeDragElement;
                        // Call a function whenever the cursor moves
                        document.onmousemove = elementDrag;
                        
                        // Add active class for styling
                        element.classList.add("dragging");
                    }
                    
                    function dragTouchStart(e) {
                        // Skip if touching a resize handle
                        if (e.target.classList.contains('resize-handle')) {
                            return;
                        }
                        
                        // Prevent scrolling while dragging
                        e.preventDefault();
                        
                        // Get the touch position at startup
                        const touch = e.touches[0];
                        pos3 = touch.clientX;
                        pos4 = touch.clientY;
                        
                        document.ontouchend = closeTouchDragElement;
                        document.ontouchmove = elementTouchDrag;
                        
                        // Add active class for styling
                        element.classList.add("dragging");
                    }
                    
                    function elementDrag(e) {
                        e.preventDefault();
                        // Calculate the new cursor position
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        
                        // Set the element's new position
                        const newTop = element.offsetTop - pos2;
                        const newLeft = element.offsetLeft - pos1;
                        
                        // Get the current scroll position of the container
                        const scrollTop = pdfContainer.scrollTop;
                        
                        // Ensure the element stays within the PDF container bounds
                        const pdfContainerRect = pdfContainer.getBoundingClientRect();
                        const elementRect = element.getBoundingClientRect();
                        
                        // Calculate boundaries
                        const minLeft = 0;
                        const maxLeft = pdfContainerRect.width - elementRect.width;
                        const minTop = scrollTop; // Adjust for scroll position
                        const maxTop = pdfContainer.scrollHeight - elementRect.height;
                        
                        // Apply boundaries
                        const boundedLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));
                        const boundedTop = Math.max(minTop, Math.min(newTop, maxTop));
                        
                        // Update position
                        element.style.top = boundedTop + 'px';
                        element.style.left = boundedLeft + 'px';
                    }
                    
                    function elementTouchDrag(e) {
                        // Prevent scrolling while dragging
                        e.preventDefault();
                        
                        const touch = e.touches[0];
                        
                        // Calculate the new touch position
                        pos1 = pos3 - touch.clientX;
                        pos2 = pos4 - touch.clientY;
                        pos3 = touch.clientX;
                        pos4 = touch.clientY;
                        
                        // Set the element's new position
                        const newTop = element.offsetTop - pos2;
                        const newLeft = element.offsetLeft - pos1;
                        
                        // Get the current scroll position of the container
                        const scrollTop = pdfContainer.scrollTop;
                        
                        // Ensure the element stays within the PDF container bounds
                        const pdfContainerRect = pdfContainer.getBoundingClientRect();
                        const elementRect = element.getBoundingClientRect();
                        
                        // Calculate boundaries
                        const minLeft = 0;
                        const maxLeft = pdfContainerRect.width - elementRect.width;
                        const minTop = scrollTop; // Adjust for scroll position
                        const maxTop = pdfContainer.scrollHeight - elementRect.height;
                        
                        // Apply boundaries
                        const boundedLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));
                        const boundedTop = Math.max(minTop, Math.min(newTop, maxTop));
                        
                        // Update position
                        element.style.top = boundedTop + 'px';
                        element.style.left = boundedLeft + 'px';
                    }
                    
                    function closeDragElement() {
                        // Stop moving when mouse button is released
                        document.onmouseup = null;
                        document.onmousemove = null;
                        element.classList.remove("dragging");
                    }
                    
                    function closeTouchDragElement() {
                        // Stop moving when touch ends
                        document.ontouchend = null;
                        document.ontouchmove = null;
                        element.classList.remove("dragging");
                    }
                }
                
                // Add resize handles to an element with improved functionality
                function addResizeHandles(element) {
                    // Create resize handles for all corners
                    const positions = ['nw', 'ne', 'sw', 'se'];
                    
                    positions.forEach(pos => {
                        const handle = document.createElement('div');
                        handle.className = `resize-handle resize-handle-${pos}`;
                        element.appendChild(handle);
                        
                        // Add resize functionality to each handle
                        handle.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            startResize(e, pos, element);
                        });
                        
                        // Add touch resize functionality
                        handle.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            startTouchResize(e, pos, element);
                        });
                    });
                }
                
                // Handle resize functionality with improved accuracy
                function startResize(e, position, element) {
                    e.preventDefault();
                    
                    // Get the image inside the wrapper
                    const img = element.querySelector('img');
                    const dateElement = element.querySelector('.date-element');
                    if (!img && !dateElement) return;
                    
                    let isResizing = true;
                    let originalWidth, originalHeight, originalX, originalY;
                    const originalMouseX = e.clientX;
                    const originalMouseY = e.clientY;
                    
                    if (img) {
                        originalWidth = img.offsetWidth;
                        originalHeight = img.offsetHeight;
                    } else {
                        originalWidth = dateElement.offsetWidth;
                        originalHeight = dateElement.offsetHeight;
                    }
                    
                    originalX = element.offsetLeft;
                    originalY = element.offsetTop;
                    
                    // Store original aspect ratio
                    const aspectRatio = originalWidth / originalHeight;
                    
                    // Add a resize class to the element
                    element.classList.add('resizing');
                    
                    function resize(e) {
                        if (!isResizing) return;
                        e.preventDefault();
                        
                        const deltaX = e.clientX - originalMouseX;
                        const deltaY = e.clientY - originalMouseY;
                        
                        let newWidth = originalWidth;
                        let newHeight = originalHeight;
                        let newX = originalX;
                        let newY = originalY;
                        
                        // Calculate new dimensions based on which handle is being dragged
                        switch (position) {
                            case 'se':
                                newWidth = originalWidth + deltaX;
                                newHeight = originalHeight + deltaY;
                                break;
                            case 'sw':
                                newWidth = originalWidth - deltaX;
                                newHeight = originalHeight + deltaY;
                                newX = originalX + deltaX;
                                break;
                            case 'ne':
                                newWidth = originalWidth + deltaX;
                                newHeight = originalHeight - deltaY;
                                newY = originalY + deltaY;
                                break;
                            case 'nw':
                                newWidth = originalWidth - deltaX;
                                newHeight = originalHeight - deltaY;
                                newX = originalX + deltaX;
                                newY = originalY + deltaY;
                                break;
                        }
                        
                        // Maintain aspect ratio for signatures (optional - remove if you want free resizing)
                        if (img && e.shiftKey) {
                            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                                newHeight = newWidth / aspectRatio;
                            } else {
                                newWidth = newHeight * aspectRatio;
                            }
                            
                            // Adjust position for aspect ratio preservation
                            if (position.includes('n')) {
                                newY = originalY + (originalHeight - newHeight);
                            }
                            if (position.includes('w')) {
                                newX = originalX + (originalWidth - newWidth);
                            }
                        }
                        
                        // Apply minimum size constraints
                        const minSize = 30;
                        if (newWidth < minSize) {
                            newWidth = minSize;
                            if (position.includes('w')) {
                                newX = originalX + (originalWidth - minSize);
                            }
                        }
                        if (newHeight < minSize) {
                            newHeight = minSize;
                            if (position.includes('n')) {
                                newY = originalY + (originalHeight - minSize);
                            }
                        }
                        
                        // Update position and size
                        element.style.left = `${newX}px`;
                        element.style.top = `${newY}px`;
                        
                        if (img) {
                            img.style.width = `${newWidth}px`;
                            img.style.height = `${newHeight}px`;
                        } else if (dateElement) {
                            dateElement.style.width = `${newWidth}px`;
                            dateElement.style.height = `${newHeight}px`;
                        }
                    }
                    
                    function stopResize() {
                        isResizing = false;
                        element.classList.remove('resizing');
                        document.removeEventListener('mousemove', resize);
                        document.removeEventListener('mouseup', stopResize);
                    }
                    
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                }

                // Handle touch resize functionality
                function startTouchResize(e, position, element) {
                    e.preventDefault();
                    
                    // Get the image inside the wrapper
                    const img = element.querySelector('img');
                    const dateElement = element.querySelector('.date-element');
                    if (!img && !dateElement) return;
                    
                    let isResizing = true;
                    let originalWidth, originalHeight, originalX, originalY;
                    const touch = e.touches[0];
                    const originalTouchX = touch.clientX;
                    const originalTouchY = touch.clientY;
                    
                    if (img) {
                        originalWidth = img.offsetWidth;
                        originalHeight = img.offsetHeight;
                    } else {
                        originalWidth = dateElement.offsetWidth;
                        originalHeight = dateElement.offsetHeight;
                    }
                    
                    originalX = element.offsetLeft;
                    originalY = element.offsetTop;
                    
                    // Store original aspect ratio
                    const aspectRatio = originalWidth / originalHeight;
                    
                    // Add a resize class to the element
                    element.classList.add('resizing');
                    
                    function touchResize(e) {
                        if (!isResizing) return;
                        e.preventDefault();
                        
                        const touch = e.touches[0];
                        const deltaX = touch.clientX - originalTouchX;
                        const deltaY = touch.clientY - originalTouchY;
                        
                        let newWidth = originalWidth;
                        let newHeight = originalHeight;
                        let newX = originalX;
                        let newY = originalY;
                        
                        // Calculate new dimensions based on which handle is being dragged
                        switch (position) {
                            case 'se':
                                newWidth = originalWidth + deltaX;
                                newHeight = originalHeight + deltaY;
                                break;
                            case 'sw':
                                newWidth = originalWidth - deltaX;
                                newHeight = originalHeight + deltaY;
                                newX = originalX + deltaX;
                                break;
                            case 'ne':
                                newWidth = originalWidth + deltaX;
                                newHeight = originalHeight - deltaY;
                                newY = originalY + deltaY;
                                break;
                            case 'nw':
                                newWidth = originalWidth - deltaX;
                                newHeight = originalHeight - deltaY;
                                newX = originalX + deltaX;
                                newY = originalY + deltaY;
                                break;
                        }
                        
                        // Apply minimum size constraints
                        const minSize = 30;
                        if (newWidth < minSize) {
                            newWidth = minSize;
                            if (position.includes('w')) {
                                newX = originalX + (originalWidth - minSize);
                            }
                        }
                        if (newHeight < minSize) {
                            newHeight = minSize;
                            if (position.includes('n')) {
                                newY = originalY + (originalHeight - minSize);
                            }
                        }
                        
                        // Update position and size
                        element.style.left = `${newX}px`;
                        element.style.top = `${newY}px`;
                        
                        if (img) {
                            img.style.width = `${newWidth}px`;
                            img.style.height = `${newHeight}px`;
                        } else if (dateElement) {
                            dateElement.style.width = `${newWidth}px`;
                            dateElement.style.height = `${newHeight}px`;
                        }
                    }
                    
                    function stopTouchResize() {
                        isResizing = false;
                        element.classList.remove('resizing');
                        document.removeEventListener('touchmove', touchResize);
                        document.removeEventListener('touchend', stopTouchResize);
                    }
                    
                    document.addEventListener('touchmove', touchResize);
                    document.addEventListener('touchend', stopTouchResize);
                }
                
                // Handle drag over for drop zone
                function handleDragOver(e) {
                    e.preventDefault();
                }
                
                // Handle drop for signatures
                function handleDrop(e) {
                    e.preventDefault();
                    
                    // Get the dragged element ID if it's from our app
                    const id = e.dataTransfer.getData('text/plain');
                    if (!id) return;
                    
                    const element = document.getElementById(id);
                    if (!element) return;
                    
                    // Calculate position relative to the PDF container
                    const rect = pdfContainer.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Update element position
                    element.style.left = x + 'px';
                    element.style.top = y + 'px';
                }
                
                // Save edited PDF with improved positioning and scaling
                async function savePDF() {
                    if (!pdfCanvasContainer) {
                        alert("PDF canvas not available. Please try again later.");
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        console.log("Starting PDF save process...");
                        
                        // Get the original PDF data
                        const pdfBytes = await pdfDocument.getData();
                        
                        // Load the PDF with PDFLib
                        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                        
                        // Get all pages
                        const pages = pdfDoc.getPages();
                        
                        // Get all canvas elements (one per page)
                        const canvasElements = document.querySelectorAll('.pdf-page-canvas');
                        
                        // Process each page
                        for (let i = 0; i < totalPages; i++) {
                            const page = pages[i];
                            const canvas = canvasElements[i];
                            
                            if (!page || !canvas) continue;
                            
                            // Get page dimensions
                            const { width, height } = page.getSize();
                            console.log(`PDF page ${i+1} dimensions:`, width, "x", height);
                            
                            // Get canvas dimensions
                            const canvasRect = canvas.getBoundingClientRect();
                            
                            // Calculate scaling factors - this is critical for correct positioning
                            const xScale = width / (canvas.width / scale);
                            const yScale = height / (canvas.height / scale);
                            
                            // Process all signatures and dates for this page
                            for (const sig of signatures) {
                                if (!sig.element) continue;
                                
                                const elementRect = sig.element.getBoundingClientRect();
                                
                                // Check if the signature is on this page
                                // We determine this by checking if the signature's position overlaps with the canvas
                                if (!(elementRect.bottom > canvasRect.top && 
                                      elementRect.top < canvasRect.bottom)) {
                                    continue; // Skip if not on this page
                                }
                                
                                // Calculate position relative to the canvas
                                const relativeLeft = elementRect.left - canvasRect.left;
                                const relativeTop = elementRect.top - canvasRect.top;
                                
                                // Convert to PDF coordinates with proper scaling
                                const x = (relativeLeft / scale) * xScale;
                                // PDF coordinates start from bottom, so we need to invert the y-coordinate
                                const y = height - (relativeTop / scale) * yScale;
                                
                                if (sig.type === "date") {
                                    const dateElement = sig.element.querySelector(".date-element");
                                    if (dateElement) {
                                        const text = dateElement.textContent || "";
                                        const fontSize = 12;
                                        page.drawText(text, {
                                            x: x,
                                            y: y - fontSize, // Adjust for text baseline
                                            size: fontSize,
                                            color: PDFLib.rgb(0.36, 0.13, 0.71),
                                        });
                                    }
                                } else if (sig.dataUrl) {
                                    const img = sig.element.querySelector(".signature-image");
                                    if (!img) continue;
                                    
                                    // Get the actual dimensions of the signature element
                                    const imgWidth = (elementRect.width / scale) * xScale;
                                    const imgHeight = (elementRect.height / scale) * yScale;
                                    
                                    try {
                                        const dataUrl = sig.dataUrl;
                                        const base64Data = dataUrl.split(",")[1];
                                        const binaryString = window.atob(base64Data);
                                        const bytes = new Uint8Array(binaryString.length);
                                        for (let i = 0; i < binaryString.length; i++) {
                                            bytes[i] = binaryString.charCodeAt(i);
                                        }
                                        
                                        const isPng = dataUrl.includes("image/png");
                                        let embeddedImage;
                                        
                                        if (isPng) {
                                            embeddedImage = await pdfDoc.embedPng(bytes);
                                        } else {
                                            embeddedImage = await pdfDoc.embedJpg(bytes);
                                        }
                                        
                                        // Draw the image at the correct position with the correct dimensions
                                        page.drawImage(embeddedImage, {
                                            x: x,
                                            y: y - imgHeight, // Adjust for PDF coordinate system
                                            width: imgWidth,
                                            height: imgHeight,
                                        });
                                    } catch (embedError) {
                                        console.error("Error embedding image:", embedError);
                                        // Fallback to a placeholder if image embedding fails
                                        page.drawRectangle({
                                            x: x,
                                            y: y - imgHeight,
                                            width: imgWidth,
                                            height: imgHeight,
                                            borderColor: PDFLib.rgb(0, 0, 0),
                                            borderWidth: 1,
                                            color: PDFLib.rgb(1, 0.9, 0.9),
                                        });
                                        page.drawText("Signature Placeholder", {
                                            x: x + 10,
                                            y: y - imgHeight / 2,
                                            size: 12,
                                            color: PDFLib.rgb(0, 0, 0),
                                        });
                                    }
                                }
                            }
                        }
                        
                        // Save the PDF
                        const modifiedPdfBytes = await pdfDoc.save();
                        const blob = new Blob([modifiedPdfBytes], { type: "application/pdf" });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.href = url;
                        link.download = "signed-document.pdf";
                        link.click();
                        URL.revokeObjectURL(url);
                        
                        try {
                            await savePDFToSalesforce(modifiedPdfBytes);
                        } catch (sfError) {
                            console.error("Error saving to Salesforce:", sfError);
                            alert("PDF was downloaded but could not be saved to Salesforce. Check console for details.");
                        }
                        
                        showLoading(false);
                    } catch (error) {
                        console.error("Error saving PDF:", error);
                        alert("Error saving PDF: " + (error.message || "Unknown error"));
                        showLoading(false);
                    }
                }
                
                // Save PDF to Salesforce with improved handling
                function savePDFToSalesforce(pdfBytes) {
                    return new Promise((resolve, reject) => {
                        try {
                            console.log("Starting Salesforce save process...");
                            
                            // Convert PDF bytes to base64
                            const base64Data = arrayBufferToBase64(pdfBytes);
                            console.log("Converted PDF to base64, length:", base64Data.length);
                            
                            // Prepare data for Salesforce
                            const pdfData = 'data:application/pdf;base64,' + base64Data;
                            
                            // Get the record ID if available
                            const urlParams = new URLSearchParams(window.location.search);
                            const recordId = urlParams.get('recordId') || '';
                            console.log("Record ID for Salesforce save:", recordId || "None provided");
                            
                            // Call Apex method to save to Salesforce
                            console.log("Calling Salesforce remoting...");
                            Visualforce.remoting.Manager.invokeAction(
                                '{!$RemoteAction.JunoSignUploadePdfController.savePDFToSalesforce}',
                                'signed-document.pdf',
                                pdfData,
                                recordId,
                                function(result, event) {
                                    if (event.status) {
                                        console.log("Salesforce save successful:", result);
                                        alert('PDF saved successfully to Salesforce!');
                                        resolve(result);
                                    } else {
                                        console.error("Salesforce save failed:", event.message);
                                        alert('PDF was downloaded but could not be saved to Salesforce: ' + event.message);
                                        reject(new Error(event.message));
                                    }
                                },
                                { 
                                    escape: false,  // Important for handling large data
                                    timeout: 120000 // Extend timeout for large files
                                }
                            );
                        } catch (error) {
                            console.error('Error in savePDFToSalesforce:', error);
                            reject(error);
                        }
                    });
                }
                
                // Helper function to convert ArrayBuffer to base64 with chunking for large files
                function arrayBufferToBase64(buffer) {
                    const bytes = new Uint8Array(buffer);
                    const len = bytes.byteLength;
                    let binary = '';
                    
                    // Process in chunks to avoid memory issues
                    const chunkSize = 65536; // 64KB chunks
                    for (let i = 0; i < len; i += chunkSize) {
                        const chunk = bytes.slice(i, Math.min(i + chunkSize, len));
                        for (let j = 0; j < chunk.length; j++) {
                            binary += String.fromCharCode(chunk[j]);
                        }
                    }
                    
                    return window.btoa(binary);
                }
                
                // Reset editor
                function resetEditor() {
                    // Clear signatures
                    signatures.forEach(sig => {
                        if (sig.element) {
                            sig.element.remove();
                        }
                    });
                    signatures = [];
                    
                    // Reset UI
                    pdfDocument = null;
                    currentPage = 1;
                    totalPages = 0;
                    scale = 1.0;
                    zoomLevelEl.textContent = '100%';
                    
                    // Show upload section, hide editor section
                    uploadSection.style.display = 'block';
                    editorSection.style.display = 'none';
                    
                    // Reset file input
                    fileInput.value = '';
                    
                    // Clear canvas container
                    if (pdfCanvasContainer) {
                        pdfCanvasContainer.innerHTML = '';
                    }
                }
            </script>
        </body>
    </html>
</apex:page>