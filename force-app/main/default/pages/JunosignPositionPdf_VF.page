<apex:page controller="PDFPositionEditorController" showHeader="false" sidebar="false" standardStylesheets="false" applyHtmlTag="false" applyBodyTag="false" docType="html-5.0">
    <html lang="en">
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>PDF Position Editor</title>
            
            <!-- Load Tailwind CSS via CDN -->
            <script src="https://cdn.tailwindcss.com"></script>
            <script>
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                primary: {
                                    DEFAULT: '#7c3aed',
                                    50: '#f5f3ff',
                                    100: '#ede9fe',
                                    200: '#ddd6fe',
                                    300: '#c4b5fd',
                                    400: '#a78bfa',
                                    500: '#8b5cf6',
                                    600: '#7c3aed',
                                    700: '#6d28d9',
                                    800: '#5b21b6',
                                    900: '#4c1d95'
                                }
                            }
                        }
                    }
                }
            </script>
            
            <!-- Load PDF.js -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
            
            <!-- Load React and ReactDOM -->
            <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
            <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
            
            <!-- Load Lucide Icons -->
            <script src="https://unpkg.com/lucide@latest"></script>
            
            <style>
                /* Base styles */
                body {
                    margin: 0;
                    padding: 0;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                }
                
                /* Loading spinner */
                .loading-spinner {
                    border: 4px solid rgba(0, 0, 0, 0.1);
                    border-left-color: #7c3aed;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </head>
        <body class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50">
            <div id="app">
                <!-- App will be rendered here -->
                <div class="flex items-center justify-center min-h-screen">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            
            <!-- Salesforce Remote Objects and Actions -->
            <apex:remoteObjects >
                <!--<apex:remoteObjectModel name="PDFPosition__c" fields="Id,Name,Left__c,Top__c,Width__c,Height__c,RecipientId__c,ContactId__c,DocumentId__c" />-->
            </apex:remoteObjects>
            
            <script>
                // Get Visualforce parameters
                const urlParams = new URLSearchParams(window.location.search);
                const documentId = '{!JSENCODE($CurrentPage.parameters.id)}';
                const contactId = '{!JSENCODE($CurrentPage.parameters.conid)}';
                const recipientId = '{!JSENCODE($CurrentPage.parameters.recid)}';
                
                // Salesforce remoting functions
                const Remoting = {
                    loadPDF: function(docId, conId, recId, callback) {
                        Visualforce.remoting.Manager.invokeAction(
                            '{!$RemoteAction.PDFPositionEditorController.getPDFById}',
                            docId, conId, recId,
                            function(result, event) {
                                if (event.status) {
                                    callback(null, result);
                                } else {
                                    callback(new Error(event.message), null);
                                }
                            },
                            { escape: false }
                        );
                    },
                    
                    savePositions: function(positions, docId, conId, recId, callback) {
                        Visualforce.remoting.Manager.invokeAction(
                            '{!$RemoteAction.PDFPositionEditorController.savePositions}',
                            JSON.stringify(positions), docId, conId, recId,
                            function(result, event) {
                                if (event.status) {
                                    callback(null, result);
                                } else {
                                    callback(new Error(event.message), null);
                                }
                            },
                            { escape: false, timeout: 120000 }
                        );
                    }
                };
                
                // Main App Component
                function PDFPositionEditor() {
                    const [pdfDocument, setPdfDocument] = React.useState(null);
                    const [currentPage, setCurrentPage] = React.useState(1);
                    const [totalPages, setTotalPages] = React.useState(0);
                    const [scale, setScale] = React.useState(1.0);
                    const [loading, setLoading] = React.useState(false);
                    const [positions, setPositions] = React.useState([]);
                    const pdfCanvasContainerRef = React.useRef(null);
                    const pdfContainerRef = React.useRef(null);
                    
                    React.useEffect(() => {
                        // Initialize PDF.js
                        if (window.pdfjsLib) {
                            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 
                                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
                        }
                        
                        if (documentId && contactId && recipientId) {
                            loadPDFFromId(documentId, contactId, recipientId);
                        } else {
                            alert("Missing required parameters. Please include 'id', 'conid', and 'recid' in the URL.");
                        }
                    }, []);
                    
                    const loadPDFFromId = (id, conid, recid) => {
                        setLoading(true);
                        const isMobile = window.innerWidth < 768;
                        const newScale = isMobile ? 1.0 : 1.2;
                        setScale(newScale);
                        
                        Remoting.loadPDF(id, conid, recid, (error, result) => {
                            if (error) {
                                console.error("Error loading PDF:", error);
                                alert("Error loading PDF: " + (error.message || "Unknown error"));
                                setLoading(false);
                                return;
                            }
                            
                            try {
                                // Convert base64 to binary
                                const binaryString = window.atob(result);
                                const bytes = new Uint8Array(binaryString.length);
                                for (let i = 0; i < binaryString.length; i++) {
                                    bytes[i] = binaryString.charCodeAt(i);
                                }
                                
                                // Load PDF with PDF.js
                                const pdfjsLib = window.pdfjsLib;
                                const loadingTask = pdfjsLib.getDocument({ data: bytes.buffer });
                                loadingTask.promise
                                    .then((pdf) => {
                                        setPdfDocument(pdf);
                                        setTotalPages(pdf.numPages);
                                        setCurrentPage(1);
                                        renderAllPages(pdf, newScale);
                                    })
                                    .catch((error) => {
                                        console.error("Error loading PDF:", error);
                                        alert("Error loading PDF: " + (error.message || "Unknown error"));
                                        setLoading(false);
                                    });
                            } catch (error) {
                                console.error("Error processing PDF data:", error);
                                alert("Error processing PDF data: " + (error.message || "Unknown error"));
                                setLoading(false);
                            }
                        });
                    };
                    
                    const renderAllPages = async (pdf, pageScale) => {
                        if (!pdfCanvasContainerRef.current) return;
                        
                        try {
                            setLoading(true);
                            
                            // Clear existing canvas container
                            pdfCanvasContainerRef.current.innerHTML = "";
                            
                            // Get total pages
                            const totalPagesCount = pdf.numPages;
                            setTotalPages(totalPagesCount);
                            
                            // Create and render each page
                            for (let pageNumber = 1; pageNumber <= totalPagesCount; pageNumber++) {
                                const page = await pdf.getPage(pageNumber);
                                const viewport = page.getViewport({ scale: pageScale });
                                
                                // Create a new canvas for each page
                                const canvas = document.createElement("canvas");
                                canvas.className = "pdf-page-canvas";
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                canvas.style.marginBottom = "20px";
                                canvas.style.boxShadow = "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)";
                                canvas.style.backgroundColor = "white";
                                
                                // Add page number indicator
                                const pageIndicator = document.createElement("div");
                                pageIndicator.className = "page-indicator";
                                pageIndicator.textContent = `Page ${pageNumber} of ${totalPagesCount}`;
                                pageIndicator.style.textAlign = "center";
                                pageIndicator.style.marginBottom = "10px";
                                pageIndicator.style.marginTop = "10px";
                                pageIndicator.style.fontWeight = "700"; // Bolder text
                                pageIndicator.style.color = "#4b5563"; // Darker gray
                                
                                // Create a wrapper for each page
                                const pageWrapper = document.createElement("div");
                                pageWrapper.className = "pdf-page-wrapper";
                                pageWrapper.appendChild(pageIndicator);
                                pageWrapper.appendChild(canvas);
                                
                                // Add to container
                                pdfCanvasContainerRef.current.appendChild(pageWrapper);
                                
                                // Render the page
                                const context = canvas.getContext("2d");
                                const renderContext = { canvasContext: context, viewport: viewport };
                                await page.render(renderContext).promise;
                            }
                            
                            setLoading(false);
                        } catch (error) {
                            console.error("Error rendering pages:", error);
                            alert("Error rendering pages: " + (error.message || "Unknown error"));
                            setLoading(false);
                        }
                    };
                    
                    const addPosition = () => {
                        const positionId = "pos-" + Date.now();
                        
                        // Get the center of the visible PDF area
                        const pdfContainerRect = pdfContainerRef.current.getBoundingClientRect();
                        const centerX = pdfContainerRect.width / 2;
                        const centerY = pdfContainerRect.height / 2;
                        
                        // Create a new position
                        const newPosition = {
                            id: positionId,
                            left: centerX - 75,
                            top: centerY - 50,
                            width: 150,
                            height: 100,
                        };
                        
                        setPositions([...positions, newPosition]);
                    };
                    
                    const deletePosition = (id) => {
                        setPositions(positions.filter((pos) => pos.id !== id));
                    };
                    
                    const handlePositionDragStart = (e, id) => {
                        // Skip if clicking on a resize handle or delete button
                        if (e.target.classList.contains("resize-handle") || e.target.classList.contains("position-delete")) {
                            return;
                        }
                        
                        const position = positions.find((pos) => pos.id === id);
                        if (!position) return;
                        
                        const startX = e.clientX;
                        const startY = e.clientY;
                        const startLeft = position.left;
                        const startTop = position.top;
                        
                        const handleMouseMove = (moveEvent) => {
                            const deltaX = moveEvent.clientX - startX;
                            const deltaY = moveEvent.clientY - startY;
                            
                            setPositions(
                                positions.map((pos) => {
                                    if (pos.id === id) {
                                        return {
                                            ...pos,
                                            left: startLeft + deltaX,
                                            top: startTop + deltaY,
                                        };
                                    }
                                    return pos;
                                })
                            );
                        };
                        
                        const handleMouseUp = () => {
                            document.removeEventListener("mousemove", handleMouseMove);
                            document.removeEventListener("mouseup", handleMouseUp);
                        };
                        
                        document.addEventListener("mousemove", handleMouseMove);
                        document.addEventListener("mouseup", handleMouseUp);
                    };
                    
                    const handlePositionResize = (e, id, corner) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const position = positions.find((pos) => pos.id === id);
                        if (!position) return;
                        
                        const startX = e.clientX;
                        const startY = e.clientY;
                        const startWidth = position.width;
                        const startHeight = position.height;
                        const startLeft = position.left;
                        const startTop = position.top;
                        
                        const handleMouseMove = (moveEvent) => {
                            const deltaX = moveEvent.clientX - startX;
                            const deltaY = moveEvent.clientY - startY;
                            
                            let newWidth = startWidth;
                            let newHeight = startHeight;
                            let newLeft = startLeft;
                            let newTop = startTop;
                            
                            // Calculate new dimensions based on which handle is being dragged
                            switch (corner) {
                                case "se":
                                    newWidth = Math.max(50, startWidth + deltaX);
                                    newHeight = Math.max(50, startHeight + deltaY);
                                    break;
                                case "sw":
                                    newWidth = Math.max(50, startWidth - deltaX);
                                    newLeft = startLeft + startWidth - newWidth;
                                    newHeight = Math.max(50, startHeight + deltaY);
                                    break;
                                case "ne":
                                    newWidth = Math.max(50, startWidth + deltaX);
                                    newHeight = Math.max(50, startHeight - deltaY);
                                    newTop = startTop + startHeight - newHeight;
                                    break;
                                case "nw":
                                    newWidth = Math.max(50, startWidth - deltaX);
                                    newLeft = startLeft + startWidth - newWidth;
                                    newHeight = Math.max(50, startHeight - deltaY);
                                    newTop = startTop + startHeight - newHeight;
                                    break;
                            }
                            
                            setPositions(
                                positions.map((pos) => {
                                    if (pos.id === id) {
                                        return {
                                            ...pos,
                                            width: newWidth,
                                            height: newHeight,
                                            left: newLeft,
                                            top: newTop,
                                        };
                                    }
                                    return pos;
                                })
                            );
                        };
                        
                        const handleMouseUp = () => {
                            document.removeEventListener("mousemove", handleMouseMove);
                            document.removeEventListener("mouseup", handleMouseUp);
                        };
                        
                        document.addEventListener("mousemove", handleMouseMove);
                        document.addEventListener("mouseup", handleMouseUp);
                    };
                    
                    const savePositions = async () => {
                        if (positions.length === 0) {
                            alert("Please add at least one position before saving.");
                            return;
                        }
                        
                        setLoading(true);
                        
                        try {
                            // Prepare positions data for Salesforce
                            const positionsData = positions.map(pos => ({
                                left: pos.left,
                                top: pos.top,
                                width: pos.width,
                                height: pos.height
                            }));
                            
                            // Save positions to Salesforce
                            Remoting.savePositions(positionsData, documentId, contactId, recipientId, (error, result) => {
                                if (error) {
                                    console.error("Error saving positions:", error);
                                    alert("Error saving positions: " + (error.message || "Unknown error"));
                                    setLoading(false);
                                    return;
                                }
                                
                                alert("Positions saved successfully to separate object!");
                                setLoading(false);
                            });
                        } catch (error) {
                            console.error("Error saving positions:", error);
                            alert("Error saving positions: " + (error.message || "Unknown error"));
                            setLoading(false);
                        }
                    };
                    
                    const zoomIn = () => {
                        const newScale = scale + 0.2;
                        setScale(newScale);
                        if (pdfDocument) {
                            renderAllPages(pdfDocument, newScale);
                        }
                    };
                    
                    const zoomOut = () => {
                        if (scale > 0.4) {
                            const newScale = scale - 0.2;
                            setScale(newScale);
                            if (pdfDocument) {
                                renderAllPages(pdfDocument, newScale);
                            }
                        }
                    };
                    
                    return React.createElement(
                        'div',
                        { className: "min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50" },
                        React.createElement(
                            'header',
                            { className: "bg-gradient-to-r from-purple-700 to-blue-600 text-white p-6 shadow-md" },
                            React.createElement(
                                'div',
                                { className: "max-w-7xl mx-auto text-center" },
                                React.createElement('h1', { className: "text-2xl font-bold" }, "JunoSign")
                            )
                        ),
                        React.createElement(
                            'main',
                            { className: "container mx-auto p-4" },
                            React.createElement(
                                'div',
                                { className: "bg-white rounded-xl shadow-lg overflow-hidden border-2 border-purple-100 flex flex-col h-screen" },
                                // Toolbar
                                React.createElement(
                                    'div',
                                    { className: "bg-gradient-to-r from-purple-700 to-blue-600 p-3 text-white flex flex-wrap items-center gap-2 sticky top-0 z-30" },
                                    React.createElement(
                                        'div',
                                        { className: "flex items-center" },
                                        React.createElement(
                                            'button',
                                            { 
                                                onClick: addPosition,
                                                className: "bg-white/20 hover:bg-white/30 text-white flex items-center gap-2 px-3 py-2 rounded-md"
                                            },
                                            React.createElement(
                                                'svg',
                                                {
                                                    xmlns: "http://www.w3.org/2000/svg",
                                                    width: "16",
                                                    height: "16",
                                                    viewBox: "0 0 24 24",
                                                    fill: "none",
                                                    stroke: "currentColor",
                                                    strokeWidth: "2",
                                                    strokeLinecap: "round",
                                                    strokeLinejoin: "round"
                                                },
                                                React.createElement('rect', { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" })
                                            ),
                                            "Position"
                                        )
                                    ),
                                    React.createElement(
                                        'div',
                                        { className: "ml-auto flex" },
                                        React.createElement(
                                            'button',
                                            {
                                                className: "bg-white/20 hover:bg-white/30 text-white mr-2 px-3 py-2 rounded-md",
                                                onClick: () => window.location.reload()
                                            },
                                            "Reject"
                                        ),
                                        React.createElement(
                                            'button',
                                            {
                                                onClick: savePositions,
                                                className: "bg-emerald-500 hover:bg-emerald-600 text-white flex items-center gap-2 px-3 py-2 rounded-md"
                                            },
                                            React.createElement(
                                                'svg',
                                                {
                                                    xmlns: "http://www.w3.org/2000/svg",
                                                    width: "16",
                                                    height: "16",
                                                    viewBox: "0 0 24 24",
                                                    fill: "none",
                                                    stroke: "currentColor",
                                                    strokeWidth: "2",
                                                    strokeLinecap: "round",
                                                    strokeLinejoin: "round"
                                                },
                                                React.createElement('path', { d: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" }),
                                                React.createElement('polyline', { points: "7 10 12 15 17 10" }),
                                                React.createElement('line', { x1: "12", y1: "15", x2: "12", y2: "3" })
                                            ),
                                            "Save Positions"
                                        )
                                    )
                                ),
                                // PDF Viewer
                                React.createElement(
                                    'div',
                                    {
                                        ref: pdfContainerRef,
                                        className: "bg-gray-100 p-4 min-h-[600px] flex flex-col items-center gap-5 overflow-y-auto flex-1 relative"
                                    },
                                    loading && React.createElement(
                                        'div',
                                        { className: "absolute inset-0 flex items-center justify-center bg-white/80 z-10" },
                                        React.createElement('div', { className: "w-12 h-12 rounded-full border-4 border-gray-200 border-t-purple-600 animate-spin" })
                                    ),
                                    React.createElement('div', { ref: pdfCanvasContainerRef, className: "flex flex-col items-center" }),
                                    // Position elements
                                    positions.map((position) => 
                                        React.createElement(
                                            'div',
                                            {
                                                key: position.id,
                                                className: "absolute border-2 border-purple-500 bg-purple-100/50 cursor-move",
                                                style: {
                                                    left: `${position.left}px`,
                                                    top: `${position.top}px`,
                                                    width: `${position.width}px`,
                                                    height: `${position.height}px`,
                                                },
                                                onMouseDown: (e) => handlePositionDragStart(e, position.id)
                                            },
                                            // Resize handles
                                            React.createElement('div', {
                                                className: "absolute w-3 h-3 bg-purple-600 border border-white rounded-sm -top-1.5 -left-1.5 cursor-nwse-resize resize-handle",
                                                onMouseDown: (e) => handlePositionResize(e, position.id, "nw")
                                            }),
                                            React.createElement('div', {
                                                className: "absolute w-3 h-3 bg-purple-600 border border-white rounded-sm -top-1.5 -right-1.5 cursor-nesw-resize resize-handle",
                                                onMouseDown: (e) => handlePositionResize(e, position.id, "ne")
                                            }),
                                            React.createElement('div', {
                                                className: "absolute w-3 h-3 bg-purple-600 border border-white rounded-sm -bottom-1.5 -left-1.5 cursor-nesw-resize resize-handle",
                                                onMouseDown: (e) => handlePositionResize(e, position.id, "sw")
                                            }),
                                            React.createElement('div', {
                                                className: "absolute w-3 h-3 bg-purple-600 border border-white rounded-sm -bottom-1.5 -right-1.5 cursor-nwse-resize resize-handle",
                                                onMouseDown: (e) => handlePositionResize(e, position.id, "se")
                                            }),
                                            // Delete button
                                            React.createElement(
                                                'button',
                                                {
                                                    className: "absolute -top-6 -right-6 bg-white rounded-full p-1 shadow-md hover:bg-red-50 position-delete",
                                                    onClick: () => deletePosition(position.id)
                                                },
                                               React.createElement(
    'svg',
    {
        xmlns: "http://www.w3.org/2000/svg",
        width: "16",
        height: "16",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round",
        className: "text-red-500"
    },
    React.createElement('polyline', { points: "3 6 5 6 21 6" }),
    React.createElement('path', { d: "M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" }),
    React.createElement('line', { x1: "10", y1: "11", x2: "10", y2: "17" }),
    React.createElement('line', { x1: "14", y1: "11", x2: "14", y2: "17" })
)
                                            )
                                        )
                                    ),
                                    // Zoom controls
                                    React.createElement(
                                        'div',
                                        { className: "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white rounded-full shadow-lg p-2 flex items-center z-20" },
                                        React.createElement(
                                            'button',
                                            {
                                                className: "w-8 h-8 flex items-center justify-center text-purple-700 hover:bg-purple-50 rounded-full",
                                                onClick: zoomOut
                                            },
                                            React.createElement(
                                                'svg',
                                                {
                                                    xmlns: "http://www.w3.org/2000/svg",
                                                    width: "16",
                                                    height: "16",
                                                    viewBox: "0 0 24 24",
                                                    fill: "none",
                                                    stroke: "currentColor",
                                                    strokeWidth: "2",
                                                    strokeLinecap: "round",
                                                    strokeLinejoin: "round"
                                                },
                                                React.createElement('circle', { cx: "11", cy: "11", r: "8" }),
                                                React.createElement('line', { x1: "21", y1: "21", x2: "16.65", y2: "16.65" }),
                                                React.createElement('line', { x1: "8", y1: "11", x2: "14", y2: "11" })
                                            )
                                        ),
                                        React.createElement('span', { className: "mx-2 text-sm font-medium text-gray-700" }, `${Math.round(scale * 100)}%`),
                                        React.createElement(
                                            'button',
                                            {
                                                className: "w-8 h-8 flex items-center justify-center text-purple-700 hover:bg-purple-50 rounded-full",
                                                onClick: zoomIn
                                            },
                                            React.createElement(
                                                'svg',
                                                {
                                                    xmlns: "http://www.w3.org/2000/svg",
                                                    width: "16",
                                                    height: "16",
                                                    viewBox: "0 0 24 24",
                                                    fill: "none",
                                                    stroke: "currentColor",
                                                    strokeWidth: "2",
                                                    strokeLinecap: "round",
                                                    strokeLinejoin: "round"
                                                },
                                                React.createElement('circle', { cx: "11", cy: "11", r: "8" }),
                                                React.createElement('line', { x1: "21", y1: "21", x2: "16.65", y2: "16.65" }),
                                                React.createElement('line', { x1: "11", y1: "8", x2: "11", y2: "14" }),
                                                React.createElement('line', { x1: "8", y1: "11", x2: "14", y2: "11" })
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    );
                }
                
                // Initialize Lucide icons
                lucide.createIcons();
                
                // Render the app
                const domContainer = document.getElementById('app');
                const root = ReactDOM.createRoot(domContainer);
                root.render(React.createElement(PDFPositionEditor));
            </script>
        </body>
    </html>
</apex:page>