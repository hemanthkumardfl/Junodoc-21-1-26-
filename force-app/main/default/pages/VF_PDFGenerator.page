<apex:page docType="html-5.0" showHeader="false" controller="PreviewPDFGenerator" action="{!getData}" standardStylesheets="false">
    <apex:slds />
    <apex:includeLightning />
    <div class="demo-only slds-m-top_xx-large" style="height:6rem;position:relative;margin-top: 14%;">
        <div class="slds-spinner_container">
            <div role="status" class="slds-spinner slds-spinner_medium slds-spinner_brand">
                <span class="slds-assistive-text">Loading, Please Wait...</span>
                <div class="slds-spinner__dot-a"></div>
                <div class="slds-spinner__dot-b"></div>
            </div>
             <div class="slds-container--fluid slds-m-top--large">
            <div class="slds-grid slds-grid--align-center slds-text-heading--small" style="margin-top: 7%;">
                Please wait ...
             </div>
        </div>
        </div>
        
    </div>
    <!--<apex:form >
        <apex:actionFunction name="callapex" action="{!RedirectTohomepage}"/>
    </apex:form>-->
      <apex:includeScript value="{!URLFOR($Resource.Pdflib)}" />

    <script>
	
    
    const createPdf = async () => {
        console.log('inside createPdf');
        //var docData = JSON.parse(JSON.stringify('{!result}'));
        //alert('docData length');
        console.log('{!result}')
       
        var docData = JSON.parse('{!result}');
        // alert(docData.length);
        // docData[0] = 'JVBERi0xLjQKJeLjz9MKNSAwIG9iaiA8PC9GaWx0ZXIvRmxhdGVEZWNvZGUvTGVuZ3RoIDI2MDI+PnN0cmVhbQp4nOVbbY/bxhH+rl+xRVsgKVwel8tdLvtNZ5+TC3yXOFZbBE0/yBLPp4CSLpLOzv2b/tTu2+zLiKQEhAUE1AZ8fuiZZ152dnd2Sf86uZ5NclLnRSZrMltObmaT95NfJ3mWs4qTL5OCfKf+/ZcJzcnd5F//zslyQsusNBq0IuuJ4DwrALYO5plSbq1k/Hcv9jj552SjiPXv3SftxNVbakVnDxNqnlNS5EpHyjpTT9eTr+jXs1+0g5To30qtqLKayKrMGFWe0MqIW9gCVByFVNDKpghEHycPI3LpyM5hEzSTzOun6Ngz++9rrHyGZyCqufTYpuMXj1EyeGhgz4/r/CxdljdpNRaE5llSjUxmpVTpLLOCmXr89mb6bvbth9fTe3J7N/3m9v4bV6CGgJE61hYyY4JIzrJSGO2CF5xcN21LftzOlwOavMgYJ7JkWS6N5t12c/i0XTe7l1dk+o4wQWk1ZJlmghLJikzURv+HR/LzV4yVP3+t/q34a1XlbEhdpVznUXlhtN/+lmrnrHDalzWcv9cbv8qUBTczjmtbasEzNA62AEtqoRNGEIT1FDxFxzLBTZVxZghERiOsGP6CKbAM4LJQq/ixT4YC7FiZ9SkdFKWjKNNAUs9TC90UqeenOY69xNkxEznjeS2J/kFr4X9GM1vGBV5Ks/nJslJFoCv89v4f39++vhmpqkMdUVPBjGWVzhenPMDWwapWAQkdmRFG0AubOhqTzqZN5pXUkUnK1VIB+EzXpUqLDNwpih3HCTGSa8Rylv9OVpOqEWDqF8E/nRlVLZKVulasIeWMw23Aaml23EbcQlOnqYqlCJStx7oyiogScEKifpgyAkMWB8ODJDgYjeNgAIMSJk1IwJPUs2PLnSQ4HJ+DiEThqlZidSD1OCbRA8vLkBOH24CHSHA4PgdRYmMlTGpIfu80H306XpxDuD9KuoRStSeCmR25tl3G7ebzdrVoyB8HeotSLeRSjZTyXO3cWis3v6gcafG9uFHxix9XDVVt2IXQO59tYSxsHdSu5GZ9McIIemG9/o1Kd2I3OMeWXitEHcgRjF3HKbGia0x0VgwgbLeEwQi4XUXz0piSuitxuA2YZQV4zVnAtv9JlKy/gbT1mLq2FORpONsFEr1Y6mSCJYuD5UESHA4vWBIOYFDCpAkJeJJ6dmy5kwSH43PgSQzWS6+oAqnHMYkeW7Xd+Jw43AY8RILD8TnwiWWJEiYdZVMYfVZenEODmwJXZwPdvqtNQdqj65v5oRk66nJjQvlsO3FaXDF6VeT+fHtx8Y+2H1jTwthaT4rabEXCmXYwdzuTlU0RiPobo1G4TuwE5xgqRcb8xRZCsdMoE1ZwfcRy2nsQHe2+a7RMXpY3g1OXFZqM22thNROvV2272nwi0+Vy1+z3A3PYajJ/z/V2vl61L+SuWa4Wq01Dtg9k9rxfzNvtdj8/yVP4Wy/KCk7uFm/nu3a+WZLr9vPyFfnwvDo0pMjLk0TUX3/db3eHxyf1xyt9ecbLSox5f3UxxRKO2UKvW6IyttSaV0awBViWGTfnR9EFQdjcO4xJd+reIbXFhcxqGvQBizyjdaBHMHY+ZejzHggwP7af3mbExte9usOZAenYV2BEzqFMY35s/9QliTDtjw7NHMTVQOhW1+E2YDhDg3xymk+UbA7UXyISi3mthjoiBZyQKMe5HiKwZHGwPEiCwymF6fa8J4BBCZM6T2L39QCkJB7D5QTIxzlJlewoBs9aj8EyyCeewEPICViCnODEdpLgcPqGOCQ2JU0SGzyJR+uYpCex6RD3haNqmcqIFHBCoh7WLKoTi9sY95PgcKAuQrFZDEqYNEkskKSjdTwanYnFQwx1EUhSyyCfeBI9NDmJEmlyghPbSYLD6RvikNiUdJzrtLF3mYtzaPg6TbKM6TEo45OT7p0+NLvPq0VyiMKnLqka4DrRfW7IiZNXWTOjVNZ9R6/O85pEWjm7oqXWGu0C79LqwLRqoqi1Cf31QwRbB3mt/iyhrUuRFz3vbOUN0YLqi1WvDli/pPZvQBEKph6Qvlro1CbFaJABDAyYH9s3nWDCoRcKod+QexnAwIFtYB9s0xNz+AH3CbYQGLAF7MHxudKJrvsCHBw7kI0TCnw9wXkGzI/txwkFzp7wPAe2gX2IEwqcKIMWegZsAXtwoou0t3s6/Wb7ofqjAQG4jTF1ZerEw8aR6thxEjTmsFh5VESUDiYU6lltTmLWjIVtBPsIUBj2etF74KBTSNmc/dhlWxqiDgQRpjIKKclDqqRJSj0kEYnFzjCIx35Ez2oepRISgVLZRYFD6RtRn8yE0XkRO26LWvJAEWHbYgX5uCeJlSwJTTmCWRCOvYie1TxKJ+QCpbOLAgfSN6w+nQmj9yLKJrRfwBBhKkNYSSZSndAnBo4iLkgQj72IntU8JBNSkSaziwCF0TeiUS5p5wQLhRlP2KOq6pxi6RTvKW29jpme1cl7HJPwWtovjqwdB1sPhyhQIGFpsCuNgV4DESYTLNRlPGePiqp7gqXTvKe0vV0nn/rhH7pc+AS6ZOCEdpLgYHrGNUppSppMs7g6w8w9qq6+aRZP9s4C91addOqFf+jy4ZPo8oGT2kmCQ+kZ3CipKWk82YAjnbxH87NjsuHpHq0QNfRUcV06+dQL/9DlA3Lo0oFS2kmBAukZ1ySjuDYuq3m/LG9OvInTL60EFVllb+XfP883h9XhZeAcWVTMdIpe502zX+xWT4fVdjN0/KQ0oyzW+xEdPY/Oq1VWxfLT9fZ5cxg4dlLKM3VIEjnN8jr5NLz7+1nVFcfCf2KvpORZng999arEq0Gtyxr98d4WlPo9BddvK8x1JY9gC7CAQ07ZBUHYHGnGpDv1tiC1xcsyKyJ9wKJyn8pZcQRj51OGPu+BAPNj++nbgtj4uldXraNSBOcQBOnYV2BEzjkIBJgf2z/x/UzizrqXbXhcQTr2HhiRu6hOMD+2P8ab39EL9+IcOvr/DkX6aV6p1xz9Tb1d/2bfz6bv0hUT/w8JXtfaY67aGtq/0vZY4tQp/TD96e7mfvZh2JagtekdlZp0xvLzDKnl02lcT99N71/fkDd/vzkvMNXQc/Y/2Q0urtz8SiX0N5JcwjWXSruHLcCSutskfoxkdHV0gkvqr4V4Vdv/ryTMt/0e2jY0IUASDqp21nz/kTrjvhS2JqzIelgDxeYI6jSC1OWUv5sicfo0BXYRJ2WMsf7/cGmwQZYiK/XKRfW7Aj3Bf9o+k8V8QzbbL+Rp/kK2m1Z/vXJ43G2fPz2S7fOObJovZLFrlquDktwtydNuu2j2e/2ZzP5lf2jWfxjoeik3KysXZtZqi4+Hw9P+b1dXytqX1eFRU/6WLbbrq49P7dVjM28Pj/vFnP5ngFTU+mU/L+uscmtp28z3jQrioF1vdg1Z7cmcsIz/mTw0DXnY7uIQ9uTj8yEIbrZeaNl8BJlspCXvAqtO67+f/BfaouHJCmVuZHN0cmVhbQplbmRvYmoKMSAwIG9iajw8L0NvbnRlbnRzIDUgMCBSL1R5cGUvUGFnZS9SZXNvdXJjZXM8PC9Qcm9jU2V0IFsvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJXS9Gb250PDwvRjEgMiAwIFIvRjIgMyAwIFIvRjMgNCAwIFI+Pj4+L1BhcmVudCA2IDAgUi9NZWRpYUJveFswIDAgNjY5LjYgOTAyLjg5XT4+CmVuZG9iago0IDAgb2JqPDwvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQvQmFzZUZvbnQvSGVsdmV0aWNhL0VuY29kaW5nL1dpbkFuc2lFbmNvZGluZz4+CmVuZG9iagoyIDAgb2JqPDwvU3VidHlwZS9UeXBlMS9UeXBlL0ZvbnQvQmFzZUZvbnQvVGltZXMtUm9tYW4vRW5jb2RpbmcvV2luQW5zaUVuY29kaW5nPj4KZW5kb2JqCjMgMCBvYmo8PC9TdWJ0eXBlL1R5cGUxL1R5cGUvRm9udC9CYXNlRm9udC9IZWx2ZXRpY2EtQm9sZC9FbmNvZGluZy9XaW5BbnNpRW5jb2Rpbmc+PgplbmRvYmoKNiAwIG9iajw8L0tpZHNbMSAwIFJdL1R5cGUvUGFnZXMvQ291bnQgMT4+CmVuZG9iago3IDAgb2JqPDwvVHlwZS9DYXRhbG9nL1BhZ2VzIDYgMCBSPj4KZW5kb2JqCjggMCBvYmo8PC9Nb2REYXRlKEQ6MjAyMTAzMDkwOTQ3MTZaKS9DcmVhdGlvbkRhdGUoRDoyMDIxMDMwOTA5NDcxNlopL1Byb2R1Y2VyKGlUZXh0IDIuMC44IFwoYnkgbG93YWdpZS5jb21cKSk+PgplbmRvYmoKeHJlZgowIDkKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAyNjg1IDAwMDAwIG4gCjAwMDAwMDI5NTEgMDAwMDAgbiAKMDAwMDAwMzA0MCAwMDAwMCBuIAowMDAwMDAyODY0IDAwMDAwIG4gCjAwMDAwMDAwMTUgMDAwMDAgbiAKMDAwMDAwMzEzMiAwMDAwMCBuIAowMDAwMDAzMTgyIDAwMDAwIG4gCjAwMDAwMDMyMjYgMDAwMDAgbiAKdHJhaWxlcgo8PC9JbmZvIDggMCBSL0lEIFs8YjU0MWY1NmJlMmI2ZWVlYmQ0MTNmZTlmMDdhNzMzNWQ+PGJjMjAzYTEyM2M4MDY5ZmQ4MDAwYWE3MDBkYjgyNmFhPl0vUm9vdCA3IDAgUi9TaXplIDk+PgpzdGFydHhyZWYKMzM0NQolJUV'
        const pdfDoc = await PDFLib.PDFDocument.create();
        console.log('pdfDoc is ', pdfDoc)
        if (docData.length < 1)
        return
        
        /* var tempBytes = Uint8Array.from(atob(docData[0]), (c) => c.charCodeAt(0));
        const pdfDocs = await PDFLib.PDFDocument.load(tempBytes)
        alert('length'+pdfDocs.getPages().length);
        var pdflength = pdfDocs.getPages().length;
        console.log('tempBytes', tempBytes)
        const [firstPage] = await pdfDoc.embedPdf(tempBytes);
        const americanFlagDims = firstPage.scale(0.8);*/
        // var page = pdfDoc.addPage();
        console.log('page is ', page)
 
        /*  page.drawPage(firstPage, {
            ...americanFlagDims,
            x: 0,
            y: 0,
            width: page.getWidth(),
        // height: page.getHeight(),
            });*/
    
    	var isLandscapecontent = '{!isLandscape}';
        var size;
        var orientation;
        
        /* if (isLandscapecontent === 'Landscape') {
          size = [1080,1920]; // Landscape size (width, height)
          orientation = 'landscape';
        } else {
          size = [842, 1191]; // A3 size (width, height)
          orientation = 'portrait';
        }
        alert('size >> '+size+'  '+'orientation >>'+orientation +'  '+'isLandscapecontent >>'+isLandscapecontent);*/
        
        if (docData.length >= 1) {
            for (let i = 0; i <docData.length; i++) {
                var tempBytes = Uint8Array.from(atob(docData[i]), (c) => c.charCodeAt(0));
                console.log('tempBtes>> ', tempBytes)
                
                const usConstitutionPdf = await PDFLib.PDFDocument.load(tempBytes);
                console.log('After ', usConstitutionPdf, usConstitutionPdf.getPages())
               
        		for(let j=0;j<usConstitutionPdf.getPages().length;j++){
         			let preamble = await pdfDoc.embedPage(usConstitutionPdf.getPages()[j]);
                    console.log(' Inside page is ', page)
                    let preambleDims = preamble.scale(0.8);
    				var page = pdfDoc.addPage();
                    page.drawPage(preamble, {
                        ...preambleDims,
                        x: 0,
                        y: -6,
                        width: page.getWidth(),
                        height: page.getHeight(), 
        				
                        //size: [792, 612],
                        //orientation: 'landscape',
                    });
    			}
                
    			
        	}
    	}
    
    
    const pdfBytes = await pdfDoc.save();
    
    saveByteArray("My PDF", pdfBytes);
    }
    
    
    function saveByteArray(pdfName, byte) {
        console.log('inside saveByteArray');
        var blob = new Blob([byte], { type: "application/pdf" });
        var link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        var fileName = pdfName;
        link.download = fileName;
        link.click();
        //window.close(); 
                   var popupBox = document.createElement('div');
            popupBox.style.display = 'flex'; // Set the display property to flex
            popupBox.style.alignItems = 'center'; // Center the content vertically
            popupBox.style.position = 'fixed';
            popupBox.style.top = '20%';
            popupBox.style.left = '50%';
            popupBox.style.transform = 'translate(-50%, -50%)';
            popupBox.style.background = 'lightgray';
            popupBox.style.padding = '20px';
            popupBox.style.border = '1px solid darkgray';
            popupBox.style.borderRadius = '5px';
            popupBox.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
            popupBox.style.zIndex = '9999';
            popupBox.style.width = '400px';
            popupBox.style.background = 'green';
            
            var iconElement = document.createElement('i');
            iconElement.className = 'fas fa-check-circle'; // Add Font Awesome classes for the check circle icon
            iconElement.style.fontSize = '14px';
            iconElement.style.color = 'white'; 
            
            var messageText = document.createElement('p');
            messageText.style.margin = '0';
            messageText.style.color = 'white';
            messageText.style.fontSize = '13px';
            messageText.style.fontWeight = 'bold';
            messageText.textContent = 'PDF has been successfully downloaded. Please check your browser\'s download location.';
            messageText.style.marginLeft = '10px';
            
            popupBox.appendChild(iconElement);
            popupBox.appendChild(messageText);
            document.body.appendChild(popupBox);
            
            setTimeout(function(){
                //callapex();
                window.close();
                document.body.removeChild(popupBox);
            }, 5000);
           window.history.back();
    }
      
    createPdf()
    </script>
    
</apex:page>