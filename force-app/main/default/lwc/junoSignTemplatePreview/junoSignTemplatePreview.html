<template>
    <div class="slds-card slds-m-bottom_medium">
        <div class="slds-card__header slds-grid">
            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__figure">
                    <lightning-icon icon-name="standard:groups" alternative-text="Groups" size="small"></lightning-icon>
                </div>
                <div class="slds-media__body">
                    <h2 class="slds-card__header-title">
                        <span>Document Setup - All Recipients</span>
                    </h2>
                </div>
            </header>
            <div class="slds-no-flex">
                <!-- <lightning-button 
                    variant="brand" 
                    label="Send for Signatures" 
                    icon-name="utility:email"
                    onclick={handleSendForSignatures}>
                </lightning-button> -->
            </div>
        </div>
        <div class="slds-card__body slds-card__body_inner">
            <!-- Recipients Management -->
            <!-- <div class="slds-section slds-is-open">
                <div class="slds-section__title-action">
                    <h3 class="slds-section__title slds-theme_shade">
                        <span class="slds-truncate">Recipients ({recipientsCount})</span>
                    </h3>
                    <lightning-button 
                        variant="neutral" 
                        label="Add Recipient" 
                        icon-name="utility:add"
                        onclick={addRecipient}>
                    </lightning-button>
                </div>
                <div class="slds-section__content">
                    <div class="slds-grid slds-wrap slds-gutters">
                        <template for:each={recipients} for:item="recipient">
                            <div key={recipient.id} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
                                <div class={recipient.cardClass}>
                                    <div class="slds-card__header">
                                        <div class="slds-grid slds-grid_align-spread">
                                            <lightning-badge label={recipient.orderLabel}></lightning-badge>
                                            <lightning-button-icon 
                                                icon-name="utility:delete" 
                                                variant="bare" 
                                                alternative-text="Remove recipient"
                                                data-recipient-id={recipient.id}
                                                onclick={removeRecipient}>
                                            </lightning-button-icon>
                                        </div>
                                    </div>
                                    <div class="slds-card__body slds-card__body_inner">
                                        <div class="slds-form-element slds-m-bottom_x-small">
                                            <lightning-input 
                                                type="text" 
                                                value={recipient.name} 
                                                placeholder="Name"
                                                data-recipient-id={recipient.id}
                                                data-field="name"
                                                onchange={updateRecipient}>
                                            </lightning-input>
                                        </div>
                                        <div class="slds-form-element slds-m-bottom_x-small">
                                            <lightning-input 
                                                type="email" 
                                                value={recipient.email} 
                                                placeholder="Email"
                                                data-recipient-id={recipient.id}
                                                data-field="email"
                                                onchange={updateRecipient}>
                                            </lightning-input>
                                        </div>
                                        <div class="slds-text-body_small slds-text-color_weak">
                                            {recipient.fieldCount} signature fields
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div> -->
        </div>
    </div>

    <div class="slds-grid slds-gutters">
        <!-- Signature Elements Palette -->
        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-4">
            <div class="slds-card">

                <!-- <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Instructions:</span>
                    </h2>
                </div> -->
                <div class="slds-card__body slds-card__body_inner">
                    <div class="slds-text-body_small slds-text-color_weak slds-m-top_small">
                        <p class="slds-text-heading_small slds-m-bottom_x-small">Instructions:</p>
                        <ul class="slds-list_dotted">
                            <li>Select recipient first</li>
                            <li>Drag elements to document</li>
                            <li>Drag placed elements to move</li>
                            <li>Send when ready</li>
                        </ul>
                    </div>
                    <div class="slds-m-top_medium">
                        <hr class="slds-separator">
                    </div>
                </div>

                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span>Elements</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                                        
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label">Assign to Recipient:</label>
                        <div class="slds-form-element__control">
                            <lightning-combobox
                                name="selectedRecipient"
                                value={selectedRecipient}
                                placeholder="Select Recipient"
                                options={recipientOptions}
                                onchange={handleRecipientChange}>
                            </lightning-combobox>
                        </div>
                    </div>

                    <div class="slds-m-bottom_medium">
                        <hr class="slds-separator">
                    </div>

                    <div class="signature-elements">
                        <div class="signature-element slds-m-bottom_small" 
                             draggable="true" 
                             data-element-type="signature"
                             ondragstart={handleDragStart}>
                            <div class="slds-media slds-media_center">
                                <div class="slds-media__figure">
                                    <lightning-icon icon-name="utility:signature" size="small" variant="inverse"></lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <span class="slds-text-heading_small">Signature</span>
                                </div>
                            </div>
                        </div>

                        <div class="signature-element slds-m-bottom_small" 
                             draggable="true" 
                             data-element-type="date"
                             ondragstart={handleDragStart}>
                            <div class="slds-media slds-media_center">
                                <div class="slds-media__figure">
                                    <lightning-icon icon-name="utility:date_input" size="small" variant="inverse"></lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <span class="slds-text-heading_small">Date</span>
                                </div>
                            </div>
                        </div>

                        <div class="signature-element slds-m-bottom_small" 
                             draggable="true" 
                             data-element-type="text"
                             ondragstart={handleDragStart}>
                            <div class="slds-media slds-media_center">
                                <div class="slds-media__figure">
                                    <lightning-icon icon-name="utility:text" size="small" variant="inverse"></lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <span class="slds-text-heading_small">Text Field</span>
                                </div>
                            </div>
                        </div>

                         <!-- <div class="signature-element slds-m-bottom_small" 
                             draggable="true" 
                             data-element-type="checkbox"
                             ondragstart={handleDragStart}>
                            <div class="slds-media slds-media_center">
                                <div class="slds-media__figure">
                                    <lightning-icon icon-name="utility:text" size="small" variant="inverse"></lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <span class="slds-text-heading_small">Checkbox Field</span>
                                </div>
                            </div>
                        </div> -->
                    </div>

                </div>
            </div>
        </div>

        <!-- Document Area -->
        <div class="slds-col slds-size_1-of-1 slds-large-size_3-of-4">
            <div class="slds-card">
                <div class="slds-card__header">
                    <div class="slds-grid slds-grid_align-spread">
                        <h2 class="slds-card__header-title">
                            <span>Document Preview</span>
                        </h2>
                        <div class="slds-grid slds-gutters_xx-small">
                            <!-- <lightning-badge label={totalFieldsLabel}></lightning-badge> -->
                            <lightning-badge label={totalRecipientsLabel}></lightning-badge>
                        </div>
                    </div>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    
                    <div class="document-container" style="overflow-y:scroll"
                        
                        >
                        
                        <!-- Document Content -->
                        <div class="document-content">
                            
                            <template if:true={previewLoaded}>
                                <template if:true={previewElements} for:each={previewElements} for:item="previewItem" for:index="index">
                                    <div key={previewItem.id} 
                                            class="preview-page-wrapper" 
                                            data-pgno={index} 
                                            style="position:relative;border: 1px solid black;" 
                                            ondrop={handleDrop} 
                                            ondragover={handleDragOver}
                                            >
                                            <!-- onmousedown={handleDocumentMouseDown}
                                            onmousemove={handleDocumentMouseMove}
                                            onmouseup={handleDocumentMouseUp} -->
                                            <img src={previewItem.pageImages} />
                                            <!-- <hr> -->
                                            <!-- Overlay for signature elements -->
                                            <div class="signature-overlay"
                                                onmousedown={handleOverlayMouseDown}
                                                >
                                                <!-- onmousemove={handleOverlayMouseMove}
                                                onmouseup={handleOverlayMouseUp} -->

                                                <!-- Signature Elements -->
                                                <template for:each={previewItem.droppedEles} for:item="element">
                                                    <div key={element.id}
                                                        class={element.elementClass}
                                                        style={element.elementStyle}
                                                        data-element-id={element.id}
                                                        >

                                                        
                                                        <!-- Drag Handle -->
                                                        <div class="drag-handle" 
                                                            onmousedown={handleElementMouseDown}
                                                            data-element-id={element.id}>
                                                            <lightning-icon icon-name="utility:move" size="xx-small"></lightning-icon>
                                                        </div>

                                                        <!-- Remove Button -->
                                                        <lightning-button-icon 
                                                            class="remove-button"
                                                            icon-name="utility:delete" 
                                                            variant="destructive" 
                                                            alternative-text="Remove element"
                                                            size="xx-small"
                                                            data-element-id={element.id}
                                                            onclick={removeElement}>
                                                        </lightning-button-icon>

                                                        <!-- Element Content -->
                                                        <div class="element-content">
                                                            <div class="slds-grid slds-grid_align-center slds-m-bottom_xx-small">
                                                                <lightning-icon icon-name={element.iconName} size="xx-small"></lightning-icon>
                                                                <span class="slds-text-body_small slds-m-left_xx-small">{element.recipientName}</span>
                                                            </div>
                                                            
                                                            <lightning-input 
                                                                type={element.fieldType}
                                                                value={element.label}
                                                                placeholder="Field label"
                                                                variant="label-hidden"
                                                                class="element-label-input"
                                                                data-element-id={element.id}
                                                                onchange={updateElementLabel}
                                                                onclick={handleLabelClick}>
                                                            </lightning-input>

                                                            <div class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                                                {element.typeLabel} • Order {element.recipientOrder}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>

                                                <!-- Drop Zone Indicator -->
                                                <template if:true={isDraggingNew}>
                                                    <div class="drop-zone-indicator">
                                                        <div class="slds-text-heading_small slds-text-color_brand">
                                                            Drop signature element here
                                                        </div>
                                                        <div class="slds-text-body_small slds-m-top_xx-small">
                                                            Will be assigned to: {selectedRecipientName}
                                                        </div>
                                                    </div>
                                                </template>

                                                <!-- iframe Loading Indicator -->
                                                <!-- <template if:false={iframeLoaded}>
                                                    <div class="iframe-loading">
                                                        <lightning-spinner alternative-text="Loading document..." size="medium"></lightning-spinner>
                                                        <p class="slds-text-heading_small slds-m-top_medium">Loading document...</p>
                                                    </div>
                                                </template> -->
                                            </div>
                                    </div>
                                        
                                </template>
                            </template>
                            <template if:false={previewLoaded}>
                                <iframe src={vfPageUrl} width="100%" height="100%"  scrolling="yes" style="overflow: auto" frameborder="0"></iframe>
                                <lightning-spinner alternative-text="Loading preview..." size="medium"></lightning-spinner>
                            </template>
                            
                            
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Card -->
    <!-- <div class="slds-card slds-m-top_medium">
        <div class="slds-card__body slds-card__body_inner">
            <div class="slds-grid slds-grid_align-spread">
                <div>
                    <div class="slds-text-heading_small">Document Summary</div>
                    <div class="slds-text-body_regular slds-text-color_weak">
                        {recipientsCount} recipients • {elementsCount} signature fields • Ready to send
                    </div>
                </div>
                <div class="slds-grid slds-gutters_small">
                    <lightning-button variant="neutral" label="Save Template"></lightning-button>
                    <lightning-button 
                        variant="brand" 
                        label="Send for Signatures" 
                        icon-name="utility:email"
                        onclick={handleSendForSignatures}>
                    </lightning-button>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Send Dialog Modal -->
    <template if:true={showSendDialog}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <div class="slds-modal__content slds-p-around_medium">
                    <div class="slds-text-align_center">
                        <lightning-spinner alternative-text="Sending..." size="medium"></lightning-spinner>
                        <h2 class="slds-text-heading_medium slds-m-top_medium">Sending documents...</h2> 
                        <!--  to all recipients 
                        <p class="slds-text-body_regular slds-text-color_weak slds-m-top_small">
                            Each recipient will receive an email with their signing instructions
                        </p>-->
                    </div>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>